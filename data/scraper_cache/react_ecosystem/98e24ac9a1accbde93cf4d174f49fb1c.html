<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tutorials/essentials/part-8-rtk-query-advanced" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">Redux Essentials, Part 8: RTK Query Advanced Patterns | Redux</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://redux.js.org/img/redux-logo-landscape.png"><meta data-rh="true" name="twitter:image" content="https://redux.js.org/img/redux-logo-landscape.png"><meta data-rh="true" property="og:url" content="https://redux.js.org/tutorials/essentials/part-8-rtk-query-advanced"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Redux Essentials, Part 8: RTK Query Advanced Patterns | Redux"><meta data-rh="true" name="description" content="The official Redux Essentials tutorial: learn advanced patterns for fetching data with RTK Query"><meta data-rh="true" property="og:description" content="The official Redux Essentials tutorial: learn advanced patterns for fetching data with RTK Query"><link data-rh="true" rel="icon" href="/img/favicon/favicon.ico"><link data-rh="true" rel="canonical" href="https://redux.js.org/tutorials/essentials/part-8-rtk-query-advanced"><link data-rh="true" rel="alternate" href="https://redux.js.org/tutorials/essentials/part-8-rtk-query-advanced" hreflang="en"><link data-rh="true" rel="alternate" href="https://redux.js.org/tutorials/essentials/part-8-rtk-query-advanced" hreflang="x-default"><link rel="preconnect" href="https://redux-docs-umami.up.railway.app">
<script async defer="defer" src="https://redux-docs-umami.up.railway.app/script.js" data-website-id="4bb3bf09-7460-453f-857d-874d8a361cb6" data-auto-track="true" data-do-not-track="true" data-cache="true" data-exclude-search="false" data-exclude-hash="false"></script><link rel="stylesheet" href="/assets/css/styles.9a914e26.css">
<script src="/assets/js/runtime~main.e50cc099.js" defer="defer"></script>
<script src="/assets/js/main.3ed293ec.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/redux.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/redux.svg" alt="Redux Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/redux.svg" alt="Redux Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Redux</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/introduction/getting-started">Getting Started</a><a class="navbar__item navbar__link" href="/tutorials/essentials/part-1-overview-concepts">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/usage/">Usage Guide</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/api/api-reference">API</a><a class="navbar__item navbar__link" href="/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/style-guide/">Best Practices</a><a href="https://www.github.com/reduxjs/redux" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a class="navbar__item navbar__link" href="/introduction/getting-started#help-and-discussion">Need help?</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/introduction/getting-started">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/tutorials/index">Tutorials</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tutorials/index">Tutorials Index</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tutorials/quick-start">Quick Start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tutorials/typescript-quick-start">TypeScript Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/tutorials/essentials/part-1-overview-concepts">Redux Essentials</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tutorials/essentials/part-1-overview-concepts">Redux Overview and Concepts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tutorials/essentials/part-2-app-structure">Redux Toolkit App Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tutorials/essentials/part-3-data-flow">Basic Redux Data Flow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tutorials/essentials/part-4-using-data">Using Redux Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tutorials/essentials/part-5-async-logic">Async Logic and Data Fetching</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tutorials/essentials/part-6-performance-normalization">Performance, Normalizing Data, and Reactive Logic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tutorials/essentials/part-7-rtk-query-basics">RTK Query Basics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/tutorials/essentials/part-8-rtk-query-advanced">RTK Query Advanced Patterns</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/tutorials/fundamentals/part-1-overview">Redux Fundamentals</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tutorials/videos">Videos</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/usage/">Using Redux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/understanding/thinking-in-redux/motivation">Understanding Redux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/faq">FAQ</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/style-guide/">Style Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/api/api-reference">API Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/redux-toolkit/overview">Redux Toolkit</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Tutorials</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Redux Essentials</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RTK Query Advanced Patterns</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Redux Essentials, Part 8: RTK Query Advanced Patterns</h1></header><div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>What You&#x27;ll Learn</div><div class="admonitionContent_BuS1"><ul>
<li>How to use tags with IDs to manage cache invalidation and refetching</li>
<li>How to work with the RTK Query cache outside of React</li>
<li>Techniques for manipulating response data</li>
<li>Implementing optimistic updates and streaming updates</li>
</ul></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Prerequisites</div><div class="admonitionContent_BuS1"><ul>
<li>Completion of <a href="/tutorials/essentials/part-7-rtk-query-basics">Part 7</a> to understand RTK Query setup and basic usage</li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>In <a href="/tutorials/essentials/part-7-rtk-query-basics">Part 7: RTK Query Basics</a>, we saw how to set up and use the RTK Query API to handle data fetching and caching in our application. We added an &quot;API slice&quot; to our Redux store, defined &quot;query&quot; endpoints to fetch posts data, and a &quot;mutation&quot; endpoint to add a new post.</p>
<p>In this section, we&#x27;ll continue migrating our example app to use RTK Query for the other data types, and see how to use some of its advanced features to simplify the codebase and improve user experience.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Some of the changes in this section aren&#x27;t strictly necessary - they&#x27;re included to demonstrate RTK Query&#x27;s features and show some of the things you <em>can</em> do, so you can see how to use these features if you need them.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="editing-posts">Editing Posts<a href="#editing-posts" class="hash-link" aria-label="Direct link to Editing Posts" title="Direct link to Editing Posts">​</a></h2>
<p>We&#x27;ve already added a mutation endpoint to save new Post entries to the server, and used that in our <code>&lt;AddPostForm&gt;</code>. Next, we need to handle updating the <code>&lt;EditPostForm&gt;</code> to let us edit an existing post.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="updating-the-edit-post-form">Updating the Edit Post Form<a href="#updating-the-edit-post-form" class="hash-link" aria-label="Direct link to Updating the Edit Post Form" title="Direct link to Updating the Edit Post Form">​</a></h3>
<p>As with adding posts, the first step is to define a new mutation endpoint in our API slice. This will look much like the mutation for adding a post, but the endpoint needs to include the post ID in the URL and use an HTTP <code>PATCH</code> request to indicate that it&#x27;s updating some of the fields.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/api/apiSlice.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> apiSlice </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createApi</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  reducerPath</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;api&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  baseQuery</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">fetchBaseQuery</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> baseUrl</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/fakeApi&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  tagTypes</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function-variable function" style="color:#E6D874">endpoints</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    getPosts</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">query</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">Post</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">[</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">]</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#F92672">void</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/posts&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      providesTags</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    getPost</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">query</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">Post</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin" style="color:#a6e22e">string</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> postId </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">/posts/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">${</span><span class="token template-string interpolation">postId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    addNewPost</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">mutation</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">Post</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> NewPost</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> initialPost </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        url</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/posts&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        method</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        body</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> initialPost</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      invalidatesTags</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    editPost</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">mutation</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">Post</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> PostUpdate</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> post </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        url</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">posts/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">${</span><span class="token template-string interpolation">post</span><span class="token template-string interpolation punctuation" style="color:#F8F8F2">.</span><span class="token template-string interpolation">id</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        method</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;PATCH&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        body</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> post</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  useGetPostsQuery</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  useGetPostQuery</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  useAddNewPostMutation</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  useEditPostMutation</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSlice</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once that&#x27;s added, we can update the <code>&lt;EditPostForm&gt;</code>. It needs to read the original <code>Post</code> entry from the store, use that to initialize the component state to edit the fields, and then send the updated changes to the server. Currently, we&#x27;re reading the <code>Post</code> entry with <code>selectPostById</code>, and manually dispatching a <code>postUpdated</code> thunk for the request.</p>
<p>We can use the same <code>useGetPostQuery</code> hook that we used in <code>&lt;SinglePostPage&gt;</code> to read the <code>Post</code> entry from the cache in the store, and we&#x27;ll use the new <code>useEditPostMutation</code> hook to handle saving the changes. If desired, we can also add a spinner and disable the form inputs while the update is in progress as well.</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/posts/EditPostForm.tsx</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;react&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> useNavigate</span><span class="token imports punctuation" style="color:#F8F8F2">,</span><span class="token imports"> useParams </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;react-router-dom&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Spinner</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/components/Spinner&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> useGetPostQuery</span><span class="token imports punctuation" style="color:#F8F8F2">,</span><span class="token imports"> useEditPostMutation </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/api/apiSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// omit form types</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">EditPostForm</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> postId </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useParams</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> navigate </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useNavigate</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> data</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> post </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useGetPostQuery</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">postId</span><span class="token operator" style="color:#F8F8F2">!</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token plain">updatePost</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> isLoading </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useEditPostMutation</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token operator" style="color:#F8F8F2">!</span><span class="token plain">post</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;</span><span class="token tag" style="color:#F92672">section</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;</span><span class="token tag" style="color:#F92672">h2</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain-text">Post not found!</span><span class="token tag punctuation" style="color:#F8F8F2">&lt;/</span><span class="token tag" style="color:#F92672">h2</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;/</span><span class="token tag" style="color:#F92672">section</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">onSavePostClicked</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    e</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access maybe-class-name">FormEvent</span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token maybe-class-name">EditPostFormElements</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// Prevent server submission</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    e</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">preventDefault</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> elements </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">currentTarget</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> title </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> elements</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">postTitle</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> content </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> elements</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">postContent</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">title </span><span class="token operator" style="color:#F8F8F2">&amp;&amp;</span><span class="token plain"> content</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#F92672">await</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">updatePost</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> id</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> post</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">id</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> title</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> content </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function" style="color:#E6D874">navigate</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">/posts/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">${</span><span class="token template-string interpolation">postId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// omit rendering</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cache-data-subscription-lifetimes">Cache Data Subscription Lifetimes<a href="#cache-data-subscription-lifetimes" class="hash-link" aria-label="Direct link to Cache Data Subscription Lifetimes" title="Direct link to Cache Data Subscription Lifetimes">​</a></h3>
<p>Let&#x27;s try this out and see what happens. Open up your browser&#x27;s DevTools, go to the Network tab, refresh the page, clear the network tab, then login. You should see a <code>GET</code> request to <code>/posts</code> as we fetch the initial data. When you click on a &quot;View Post&quot; button, you should see a second request to <code>/posts/:postId</code> that returns that single post entry.</p>
<p>Now click &quot;Edit Post&quot; inside the single post page. The UI switches over to show <code>&lt;EditPostForm&gt;</code>, but this time there&#x27;s no network request for the individual post. Why not?</p>
<p><img decoding="async" loading="lazy" alt="RTK Query network requests" src="/assets/images/devtools-cached-requests-79d7905036f9236ebed6c895b78b129d.png" width="2560" height="489" class="img_ev3q"></p>
<p><strong>RTK Query allows multiple components to subscribe to the same data, and will ensure that each unique set of data is only fetched once.</strong> Internally, RTK Query keeps a reference counter of active &quot;subscriptions&quot; to each endpoint + cache key combination. If Component A calls <code>useGetPostQuery(42)</code>, that data will be fetched. If Component B then mounts and also calls <code>useGetPostQuery(42)</code>, it&#x27;s asking for the same data. We already have an existing cache entry, so there&#x27;s no need for a request. The two hook usages will return the exact same results, including fetched <code>data</code> and loading status flags.</p>
<p>When the number of active subscriptions goes down to 0, RTK Query starts an internal timer. <strong>If the timer expires before any new subscriptions for the data are added, RTK Query will remove that data from the cache automatically</strong>, because the app no longer needs the data. However, if a new subscription <em>is</em> added before the timer expires, the timer is canceled, and the already-cached data is used without needing to refetch it.</p>
<p>In this case, our <code>&lt;SinglePostPage&gt;</code> mounted and requested that individual <code>Post</code> by ID. When we clicked on &quot;Edit Post&quot;, the <code>&lt;SinglePostPage&gt;</code> component was unmounted by the router, and the active subscription was removed due to unmounting. RTK Query immediately started a &quot;remove this post data&quot; timer. But, the <code>&lt;EditPostPage&gt;</code> component mounted right away and subscribed to the same <code>Post</code> data with the same cache key. So, RTK Query canceled the timer and kept using the same cached data instead of fetching it from the server.</p>
<p>By default, <strong>unused data is removed from the cache after 60 seconds</strong>, but this can be configured in either the root API slice definition or overridden in the individual endpoint definitions using the <code>keepUnusedDataFor</code> flag, which specifies a cache lifetime in seconds.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="invalidating-specific-items">Invalidating Specific Items<a href="#invalidating-specific-items" class="hash-link" aria-label="Direct link to Invalidating Specific Items" title="Direct link to Invalidating Specific Items">​</a></h3>
<p>Our <code>&lt;EditPostForm&gt;</code> component can now save the edited post to the server, but we have a problem. If we click &quot;Save Post&quot; while editing, it returns us to the <code>&lt;SinglePostPage&gt;</code>, but it&#x27;s still showing the old data without the edits. The <code>&lt;SinglePostPage&gt;</code> is still using the cached <code>Post</code> entry that was fetched earlier. For that matter, if we return to the main page and look at the <code>&lt;PostsList&gt;</code>, it&#x27;s also showing the old data. <strong>We need a way to force a refetch of <em>both</em> the individual <code>Post</code> entry, and the entire list of posts</strong>.</p>
<p>Earlier, we saw how we can use &quot;tags&quot; to invalidate parts of our cached data. We declared that the <code>getPosts</code> query endpoint <em>provides</em> a <code>&#x27;Post&#x27;</code> tag, and that the <code>addNewPost</code> mutation endpoint <em>invalidates</em> that same <code>&#x27;Post&#x27;</code> tag. That way, every time we add a new post, we force RTK Query to refetch the entire list of posts from the <code>getQuery</code> endpoint.</p>
<p>We could add a <code>&#x27;Post&#x27;</code> tag to both the <code>getPost</code> query and the <code>editPost</code> mutation, but that would force all the other individual posts to be refetched as well. Fortunately, <strong>RTK Query lets us define specific tags, which let us be more selective in invalidating data</strong>. These specific tags look like <code>{type: &#x27;Post&#x27;, id: 123}</code>.</p>
<p>Our <code>getPosts</code> query defines a <code>providesTags</code> field that is an array of strings. The <code>providesTags</code> field can also accept a callback function that receives the <code>result</code> and <code>arg</code>, and returns an array. This allows us to create tag entries based on IDs of data that is being fetched. Similarly, <code>invalidatesTags</code> can be a callback as well.</p>
<p>In order to get the right behavior, we need to set up each endpoint with the right tags:</p>
<ul>
<li><code>getPosts</code>: provides a general <code>&#x27;Post&#x27;</code> tag for the whole list, as well as a specific <code>{type: &#x27;Post&#x27;, id}</code> tag for each received post object</li>
<li><code>getPost</code>: provides a specific <code>{type: &#x27;Post&#x27;, id}</code> object for the individual post object</li>
<li><code>addNewPost</code>: invalidates the general <code>&#x27;Post&#x27;</code> tag, to refetch the whole list</li>
<li><code>editPost</code>: invalidates the specific <code>{type: &#x27;Post&#x27;, id}</code> tag. This will force a refetch of both the <em>individual</em> post from <code>getPost</code>, as well as the <em>entire</em> list of posts from <code>getPosts</code>, because they both provide a tag that matches that <code>{type, id}</code> value.</li>
</ul>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/api/apiSlice.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> apiSlice </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createApi</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  reducerPath</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;api&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  baseQuery</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">fetchBaseQuery</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> baseUrl</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/fakeApi&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  tagTypes</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function-variable function" style="color:#E6D874">endpoints</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    getPosts</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">query</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">Post</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">[</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">]</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#F92672">void</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/posts&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">providesTags</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">result </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token operator" style="color:#F8F8F2">...</span><span class="token plain">result</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">map</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> id </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> type</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> id </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">as</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    getPost</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">query</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">Post</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin" style="color:#a6e22e">string</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> postId </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">/posts/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">${</span><span class="token template-string interpolation">postId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">providesTags</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> type</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> id</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> arg </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    addNewPost</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">mutation</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">Post</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> NewPost</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> initialPost </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        url</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/posts&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        method</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        body</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> initialPost</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      invalidatesTags</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    editPost</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">mutation</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">Post</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> PostUpdate</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> post </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        url</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">posts/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">${</span><span class="token template-string interpolation">post</span><span class="token template-string interpolation punctuation" style="color:#F8F8F2">.</span><span class="token template-string interpolation">id</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        method</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;PATCH&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        body</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> post</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">invalidatesTags</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> type</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> id</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">id </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It&#x27;s possible for the <code>result</code> argument in these callbacks to be undefined if the response has no data or there&#x27;s an error, so we have to handle that safely. For <code>getPosts</code> we can do that by using a default argument array value to map over, and for <code>getPost</code> we&#x27;re already returning a single-item array based on the argument ID. For <code>editPost</code>, we know the ID of the post from the partial post object that was passed into the trigger function, so we can read it from there.</p>
<p>With those changes in place, let&#x27;s go back and try editing a post again, with the Network tab open in the browser DevTools.</p>
<p><img decoding="async" loading="lazy" alt="RTK Query invalidation and refetching" src="/assets/images/devtools-cached-invalidation-refetching-1471eaacbbce8cb57df69d0807c72584.png" width="2560" height="601" class="img_ev3q"></p>
<p>When we save the edited post this time, we should see two requests happen back-to-back:</p>
<ul>
<li>The <code>PATCH /posts/:postId</code> from the <code>editPost</code> mutation</li>
<li>A <code>GET /posts/:postId</code> as the <code>getPost</code> query is refetched</li>
</ul>
<p>Then, if we click back to the main &quot;Posts&quot; tab, we should also see:</p>
<ul>
<li>A <code>GET /posts</code> as the <code>getPosts</code> query is refetched</li>
</ul>
<p>Because we provided the relationships between the endpoints using tags, <strong>RTK Query knew that it needed to refetch the individual post and the list of posts when we made that edit and the specific tag with that ID was invalidated</strong> - no further changes needed! Meanwhile, as we were editing the post, the cache removal timer for the <code>getPosts</code> data expired, so it was removed from the cache. When we opened the <code>&lt;PostsList&gt;</code> component again, RTK Query saw that it did not have the data in cache and refetched it.</p>
<p>There is one caveat here. By specifying a plain <code>&#x27;Post&#x27;</code> tag in <code>getPosts</code> and invalidating it in <code>addNewPost</code>, we actually end up forcing a refetch of all <em>individual</em> posts as well. If we really want to just refetch the list of posts for the <code>getPosts</code> endpoint, you can include an additional tag with an arbitrary ID, like <code>{type: &#x27;Post&#x27;, id: &#x27;LIST&#x27;}</code>, and invalidate that tag instead. The RTK Query docs have <a href="https://redux-toolkit.js.org/rtk-query/usage/automated-refetching#tag-invalidation-behavior" target="_blank" rel="noopener noreferrer">a table that describes what will happen if certain general/specific tag combinations are invalidated</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>RTK Query has many other options for controlling when and how to refetch data, including &quot;conditional fetching&quot;, &quot;lazy queries&quot;, and &quot;prefetching&quot;, and query definitions can be customized in a variety of ways. See the RTK Query usage guide docs for more details on using these features:</p><ul>
<li><a href="https://redux-toolkit.js.org/rtk-query/usage/automated-refetching" target="_blank" rel="noopener noreferrer">RTK Query: Automated Re-Fetching</a></li>
<li><a href="https://redux-toolkit.js.org/rtk-query/usage/conditional-fetching" target="_blank" rel="noopener noreferrer">RTK Query: Conditional Fetching</a></li>
<li><a href="https://redux-toolkit.js.org/rtk-query/usage/prefetching" target="_blank" rel="noopener noreferrer">RTK Query: Prefetching</a></li>
<li><a href="https://redux-toolkit.js.org/rtk-query/usage/customizing-queries" target="_blank" rel="noopener noreferrer">RTK Query: Customizing Queries</a></li>
<li><a href="https://redux-toolkit.js.org/rtk-query/api/created-api/hooks#uselazyquery" target="_blank" rel="noopener noreferrer">RTK Query: <code>useLazyQuery</code></a></li>
</ul></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="updating-toast-display">Updating Toast Display<a href="#updating-toast-display" class="hash-link" aria-label="Direct link to Updating Toast Display" title="Direct link to Updating Toast Display">​</a></h3>
<p>When we switched from dispatching thunks for adding posts to using an RTK Query mutation, we accidentally broke the &quot;New post added&quot; toast message behavior, because the <code>addNewPost.fulfilled</code> action is no longer getting dispatched.</p>
<p>Fortunately, this is simple to fix. RTK Query actually uses <code>createAsyncThunk</code> internally, and we&#x27;ve already seen that it dispatches Redux actions as the requests are made. We can update the toast listener to watch for RTKQ&#x27;s internal actions being dispatched, and show the toast message when that happens.</p>
<p><code>createApi</code> automatically generates thunks internally for each endpoint. It also automatically generates <a href="https://redux-toolkit.js.org/api/matching-utilities" target="_blank" rel="noopener noreferrer">RTK &quot;matcher&quot; functions</a>, which accept an action object and return <code>true</code> if the action matches some condition. These matchers can be used in any place that needs to check if an action matches a given condition, such as inside <code>startAppListening</code>. They also act as TypeScript type guards, narrowing the TS type of the <code>action</code> object so that you can safely access its fields.</p>
<p>Currently, the toast listener is watching for the single specific action type with <code>actionCreator: addNewPost.fulfilled</code>. We&#x27;ll update it to watch for the posts being added with <code>matcher: apiSlice.endpoints.addNewPost.matchFulfilled</code>:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/posts/postsSlice.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> createEntityAdapter</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> createSelector</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> createSlice</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> EntityState</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> PayloadAction </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@reduxjs/toolkit&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> client </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/api/client&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> RootState </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/app/store&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> AppStartListening </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/app/listenerMiddleware&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> createAppAsyncThunk </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/app/withTypes&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> apiSlice </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/api/apiSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> logout </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/auth/authSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// omit types, posts slice, and selectors</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">addPostsListeners</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">startAppListening</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> AppStartListening</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#E6D874">startAppListening</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    matcher</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> apiSlice</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">endpoints</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">addNewPost</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">matchFulfilled</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function-variable function" style="color:#E6D874">effect</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">action</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> listenerApi</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now the toast should show correctly again when we add a post.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="managing-users-data">Managing Users Data<a href="#managing-users-data" class="hash-link" aria-label="Direct link to Managing Users Data" title="Direct link to Managing Users Data">​</a></h2>
<p>We&#x27;ve finished converting our posts data management over to use RTK Query. Next up, we&#x27;ll convert the list of users.</p>
<p>Since we&#x27;ve already seen how to use the RTK Query hooks for fetching and reading data, for this section we&#x27;re going to try a different approach. <strong>Like the rest of Redux Toolkit, RTK Query&#x27;s core logic is UI-agnostic and can be used with any UI layer, not just React</strong>.</p>
<p>Normally you should use the React hooks that <code>createApi</code> generates, since they do a lot of work for you. But, for sake of illustration, here we&#x27;re going to work with the user data using <em>just</em> the RTK Query core API so you can see how to use it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fetching-users-manually">Fetching Users Manually<a href="#fetching-users-manually" class="hash-link" aria-label="Direct link to Fetching Users Manually" title="Direct link to Fetching Users Manually">​</a></h3>
<p>We&#x27;re currently defining a <code>fetchUsers</code> async thunk in <code>usersSlice.ts</code>, and dispatching that thunk manually in <code>main.tsx</code> so that the list of users is available as soon as possible. We can do that same process using RTK Query.</p>
<p>We&#x27;ll start by defining a <code>getUsers</code> query endpoint in <code>apiSlice.ts</code>, similar to our existing endpoints. We&#x27;ll export the <code>useGetUsersQuery</code> hook just for consistency, but for now we&#x27;re not going to use it.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/api/apiSlice.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> createApi</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> fetchBaseQuery </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@reduxjs/toolkit/query/react&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> Post</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> NewPost</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> PostUpdate </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/posts/postsSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> User </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/users/usersSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> Post </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> apiSlice </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createApi</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  reducerPath</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;api&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  baseQuery</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">fetchBaseQuery</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> baseUrl</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/fakeApi&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  tagTypes</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function-variable function" style="color:#E6D874">endpoints</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// omit other endpoints</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    getUsers</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">query</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">User</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">[</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">]</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#F92672">void</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/users&#x27;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  useGetPostsQuery</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  useGetPostQuery</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  useGetUsersQuery</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  useAddNewPostMutation</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  useEditPostMutation</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSlice</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we inspect the API slice object, it includes an <code>endpoints</code> field, with one endpoint object inside for each endpoint we&#x27;ve defined.</p>
<p><img decoding="async" loading="lazy" alt="API slice endpoint contents" src="/assets/images/api-slice-contents-62291fe341d9aa651999b46c580fe3df.png" width="1248" height="724" class="img_ev3q"></p>
<p>Each endpoint object contains:</p>
<ul>
<li>The same primary query/mutation hook that we exported from the root API slice object, but named as <code>useQuery</code> or <code>useMutation</code></li>
<li>For query endpoints, an additional set of query hooks for scenarios like &quot;lazy queries&quot; or partial subscriptions</li>
<li>A set of <a href="https://redux-toolkit.js.org/api/matching-utilities" target="_blank" rel="noopener noreferrer">&quot;matcher&quot; utilities</a> to check for the <code>pending/fulfilled/rejected</code> actions dispatched by requests for this endpoint</li>
<li>An <code>initiate</code> thunk that triggers a request for this endpoint</li>
<li>A <code>select</code> function that creates <a href="/usage/deriving-data-selectors">memoized selectors</a> that can retrieve the cached result data + status entries for this endpoint</li>
</ul>
<p>If we want to fetch the list of users outside of React, we can dispatch the <code>getUsers.initiate()</code> thunk in our index file:</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">main.tsx</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#c6cad2">// omit other imports</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> apiSlice </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./features/api/apiSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">async</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">function</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">main</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// Start our mock API server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">await</span><span class="token plain"> worker</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">start</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> onUnhandledRequest</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;bypass&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  store</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">dispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">apiSlice</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">endpoints</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">getUsers</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">initiate</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> root </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createRoot</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token dom variable" style="color:#F8F8F2">document</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">getElementById</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token string" style="color:#a6e22e">&#x27;root&#x27;</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token operator" style="color:#F8F8F2">!</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  root</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">render</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;</span><span class="token tag class-name" style="color:#F92672">React.StrictMode</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;</span><span class="token tag class-name" style="color:#F92672">Provider</span><span class="token tag" style="color:#F92672"> </span><span class="token tag attr-name" style="color:#a6e22e">store</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#F8F8F2">=</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">{</span><span class="token tag script language-javascript" style="color:#F92672">store</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">}</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;</span><span class="token tag class-name" style="color:#F92672">App</span><span class="token tag" style="color:#F92672"> </span><span class="token tag punctuation" style="color:#F8F8F2">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;/</span><span class="token tag class-name" style="color:#F92672">Provider</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;/</span><span class="token tag class-name" style="color:#F92672">React.StrictMode</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#E6D874">main</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This dispatch happens automatically inside the query hooks, but we can start it manually if needed by dispatching the <code>initiate</code> thunk.</p>
<p>Note that we didn&#x27;t provide an argument to <code>initiate()</code>. That&#x27;s because our <code>getUsers</code> endpoint doesn&#x27;t need a specific query argument. Conceptually, this is the same as saying &quot;this cache entry has a query argument of <code>undefined</code>&quot;. If we did need arguments, we&#x27;d pass them to the thunk, like <code>dispatch(apiSlice.endpoints.getPokemon.initiate(&#x27;pikachu&#x27;))</code>.</p>
<p>In this case, we&#x27;re manually dispatching the thunk to start prefetching the data in our app&#x27;s setup function. In practice, you may want to do the prefetching in <a href="https://reactrouter.com/en/main/route/loader" target="_blank" rel="noopener noreferrer">React-Router&#x27;s &quot;data loaders&quot;</a> to start the requests before the components are rendered. (See <a href="https://github.com/reduxjs/redux-toolkit/discussions/2751" target="_blank" rel="noopener noreferrer">the RTK repo discussion thread on React-Router loaders</a> for some ideas.)</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_BuS1"><p>Manually dispatching an RTKQ request thunk will create a subscription entry, but it&#x27;s then up to you to <a href="https://redux-toolkit.js.org/rtk-query/usage/usage-without-react-hooks#removing-a-subscription" target="_blank" rel="noopener noreferrer">unsubscribe from that data later</a> - otherwise the data stays in the cache permanently. In this case, we always need user data, so we can skip unsubscribing.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="selecting-users-data">Selecting Users Data<a href="#selecting-users-data" class="hash-link" aria-label="Direct link to Selecting Users Data" title="Direct link to Selecting Users Data">​</a></h3>
<p>We currently have selectors like <code>selectAllUsers</code> and <code>selectUserById</code> that are generated by our <code>createEntityAdapter</code> users adapter, and are reading from <code>state.users</code>. If we reload the page, <strong>all of our user-related display is broken because the <code>state.users</code> slice has no data</strong>. Now that we&#x27;re fetching data for RTK Query&#x27;s cache, <strong>we should replace those selectors with equivalents that read from the cache instead</strong>.</p>
<p>The <code>endpoint.select()</code> function in the API slice endpoints will create a new memoized selector function <em>every</em> time we call it. <code>select()</code> takes a cache key as its argument, and this must be the <em>same</em> cache key that you pass as an argument to either the query hooks or the <code>initiate()</code> thunk. The generated selector uses that cache key to know exactly which cached result it should return from the cache state in the store.</p>
<p>In this case, our <code>getUsers</code> endpoint doesn&#x27;t need any parameters - we always fetch the entire list of users. So, we can create a cache selector with no argument (which is the same as passing a cache key of <code>undefined</code>).</p>
<p>We can update <code>usersSlice.ts</code> to base its selectors on the RTKQ query cache instead of the actual <code>usersSlice</code> call:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/users/usersSlice.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  createEntityAdapter</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  createSelector</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  createSlice</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@reduxjs/toolkit&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> client </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/api/client&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> RootState </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/app/store&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> createAppAsyncThunk </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/app/withTypes&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> apiSlice </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/api/apiSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> selectCurrentUsername </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/auth/authSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">interface</span><span class="token plain"> </span><span class="token class-name">User</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  id</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#a6e22e">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  name</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#a6e22e">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// omit `fetchUsers` and `usersSlice`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> emptyUsers</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> User</span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// Calling `someEndpoint.select(someArg)` generates a new selector that will return</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// the query result object for a query with those parameters.</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// To generate a selector for a specific query argument, call `select(theQueryArg)`.</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// In this case, the users query has no params, so we don&#x27;t pass anything to select()</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> selectUsersResult </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSlice</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">endpoints</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">getUsers</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">select</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> selectAllUsers </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createSelector</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  selectUsersResult</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  usersResult </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> usersResult</span><span class="token operator" style="color:#F8F8F2">?.</span><span class="token plain">data </span><span class="token operator" style="color:#F8F8F2">??</span><span class="token plain"> emptyUsers</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> selectUserById </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createSelector</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  selectAllUsers</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> RootState</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> userId</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#a6e22e">string</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> userId</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">users</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> userId</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> users</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">find</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">user </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> user</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">id </span><span class="token operator" style="color:#F8F8F2">===</span><span class="token plain"> userId</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">selectCurrentUser</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> RootState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> currentUsername </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">selectCurrentUsername</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">currentUsername</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">return</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">selectUserById</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> currentUsername</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">/* Temporarily ignore adapter selectors - we&#x27;ll come back to this later</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#c6cad2">export const { selectAll: selectAllUsers, selectById: selectUserById } = usersAdapter.getSelectors(</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#c6cad2">  (state: RootState) =&gt; state.users,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#c6cad2">)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#c6cad2">*/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We start by creating a specific <code>selectUsersResult</code> selector instance that knows how to retrieve the right cache entry.</p>
<p>Once we have that initial <code>selectUsersResult</code> selector, we can replace the existing <code>selectAllUsers</code> selector with one that returns the array of users from the cache result. Since there might not be a valid result yet, we fall back to an <code>emptyUsers</code> array. We&#x27;ll also replace <code>selectUserById</code> with one that finds the right user from that array.</p>
<p>For now we&#x27;re going to comment out those selectors from the <code>usersAdapter</code> - we&#x27;re going to make another change later that switches back to using those.</p>
<p>Our components are already importing <code>selectAllUsers</code>, <code>selectUserById</code>, and <code>selectCurrentUser</code>, so this change should just work! Try refreshing the page and clicking through the posts list and single post view. The correct user names should appear in each displayed post, and in the dropdown in the <code>&lt;AddPostForm&gt;</code>.</p>
<p><strong>Note that this is a great example of how using selectors makes the code more maintainable!</strong> We already had our components calling these selectors, so they don&#x27;t care whether the data is coming from the existing <code>usersSlice</code> state, or from an RTK Query cache entry, as long as the selectors return the expected data. We were able to change out the selector implementations and <em>didn&#x27;t</em> have to update the UI components at all.</p>
<p>Since the <code>usersSlice</code> state is no longer even being used at all, we can go ahead and delete the <code>const usersSlice = createSlice()</code> call and the <code>fetchUsers</code> thunk from this file, and remove <code>users: usersReducer</code> from our store setup. We&#x27;ve still got a couple bits of code that reference <code>postsSlice</code>, so we can&#x27;t quite remove that yet - we&#x27;ll get to that shortly.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="splitting-and-injecting-endpoints">Splitting and Injecting Endpoints<a href="#splitting-and-injecting-endpoints" class="hash-link" aria-label="Direct link to Splitting and Injecting Endpoints" title="Direct link to Splitting and Injecting Endpoints">​</a></h3>
<p>We said that <strong>RTK Query normally has a single &quot;API slice&quot; per application</strong>, and so far we&#x27;ve defined all of our endpoints directly in <code>apiSlice.ts</code>. But, it&#x27;s common for larger applications to &quot;code-split&quot; features into separate bundles, and then &quot;lazy load&quot; them on demand as the feature is used for the first time. . What happens if we want to code-split some of our endpoint definitions, or move them into another file to keep the API slice file from getting too big?</p>
<p><strong>RTK Query supports splitting out endpoint definitions with <code>apiSlice.injectEndpoints()</code></strong>. That way, we can still have a single API slice instance, with a single middleware and cache reducer, but we can move the definition of some endpoints to other files. This enables code-splitting scenarios, as well as co-locating some endpoints alongside feature folders if desired.</p>
<p>To illustrate this process, let&#x27;s switch the <code>getUsers</code> endpoint to be injected in <code>usersSlice.ts</code>, instead of defined in <code>apiSlice.ts</code>.</p>
<p>We&#x27;re already importing <code>apiSlice</code> into <code>usersSlice.ts</code> so that we can access the <code>getUsers</code> endpoint, so we can switch to calling <code>apiSlice.injectEndpoints()</code> here instead.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/users/usersSlice.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> apiSlice </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;../api/apiSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// This is the _same_ reference as `apiSlice`, but this has</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// the TS types updated to include the injected endpoints</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> apiSliceWithUsers </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSlice</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">injectEndpoints</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function-variable function" style="color:#E6D874">endpoints</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    getUsers</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">query</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">User</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">[</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">]</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#F92672">void</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/users&#x27;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> useGetUsersQuery </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSliceWithUsers</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> selectUsersResult </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSliceWithUsers</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">endpoints</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">getUsers</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">select</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>injectEndpoints()</code> <strong>mutates the original API slice object to add the additional endpoint definitions, and then returns the <em>same</em> API reference</strong>. Additionally, <strong>the return value of <code>injectEndpoints</code> has the additional TS types from the injected endpoints included</strong>.</p>
<p>Because of that, we should save this as a new variable with a different name, so that we can use the updated TS types, have everything compile correctly, and remind ourselves which version of the API slice we&#x27;re using. Here, we&#x27;ll call it <code>apiSliceWithUsers</code> to differentiate it from the original <code>apiSlice</code>.</p>
<p>At the moment, the only file that references the <code>getUsers</code> endpoint is our entry point file, which is dispatching the <code>initiate</code> thunk. We need to update that to import the extended API slice instead:</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">main.tsx</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> apiSliceWithUsers </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./features/users/usersSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> worker </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./api/server&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./index.css&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// Wrap app rendering so we can wait for the mock API to initialize</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">async</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">function</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">start</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// Start our mock API server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">await</span><span class="token plain"> worker</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">start</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> onUnhandledRequest</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;bypass&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  store</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">dispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">apiSliceWithUsers</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">endpoints</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">getUsers</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">initiate</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> root </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createRoot</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token dom variable" style="color:#F8F8F2">document</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">getElementById</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token string" style="color:#a6e22e">&#x27;root&#x27;</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token operator" style="color:#F8F8F2">!</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  root</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">render</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;</span><span class="token tag class-name" style="color:#F92672">React.StrictMode</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;</span><span class="token tag class-name" style="color:#F92672">Provider</span><span class="token tag" style="color:#F92672"> </span><span class="token tag attr-name" style="color:#a6e22e">store</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#F8F8F2">=</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">{</span><span class="token tag script language-javascript" style="color:#F92672">store</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">}</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;</span><span class="token tag class-name" style="color:#F92672">App</span><span class="token tag" style="color:#F92672"> </span><span class="token tag punctuation" style="color:#F8F8F2">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;/</span><span class="token tag class-name" style="color:#F92672">Provider</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;/</span><span class="token tag class-name" style="color:#F92672">React.StrictMode</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Alternately, you could just export the specific endpoints themselves from the slice file, the same way we&#x27;ve done with action creators in slices.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="manipulating-response-data">Manipulating Response Data<a href="#manipulating-response-data" class="hash-link" aria-label="Direct link to Manipulating Response Data" title="Direct link to Manipulating Response Data">​</a></h2>
<p>So far, all of our query endpoints have simply stored the response data from the server exactly as it was received in the body. <code>getPosts</code> and <code>getUsers</code> both expect the server to return an array, and <code>getPost</code> expects the individual <code>Post</code> object as the body.</p>
<p>It&#x27;s common for clients to need to extract pieces of data from the server response, or to transform the data in some way before caching it. For example, what if the <code>/getPost</code> request returns a body like <code>{post: {id}}</code>, with the data nested?</p>
<p>There&#x27;s a couple ways that we <em>could</em> handle this conceptually. One option would be to extract the <code>responseData.post</code> field and store that in the cache, instead of the entire body. Another would be to store the entire response data in the cache, but have our components specify just a specific piece of that cached data that they need.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="transforming-responses">Transforming Responses<a href="#transforming-responses" class="hash-link" aria-label="Direct link to Transforming Responses" title="Direct link to Transforming Responses">​</a></h3>
<p><strong>Endpoints can define a <code>transformResponse</code> handler that can extract or modify the data received from the server before it&#x27;s cached</strong>. For example, if <code>getPost</code> returned <code>{post: {id}}</code>, we could have <code>transformResponse: (responseData) =&gt; responseData.post</code>, and it would cache just the actual <code>Post</code> object instead of the entire body of the response.</p>
<p>In <a href="/tutorials/essentials/part-6-performance-normalization">Part 6: Performance and Normalization</a>, we discussed reasons why it&#x27;s useful to store data in a normalized structure. In particular, it lets us look up and update items based on an ID, rather than having to loop over an array to find the right item.</p>
<p>Our <code>selectUserById</code> selector currently has to loop over the cached array of users to find the right <code>User</code> object. If we were to transform the response data to be stored using a normalized approach, we could simplify that to directly find the user by ID.</p>
<p>We were previously using <code>createEntityAdapter</code> in <code>usersSlice</code> to manage normalized users data. We can integrate <code>createEntityAdapter</code> into our <code>extendedApiSlice</code>, and actually use <code>createEntityAdapter</code> to transform the data before it&#x27;s cached. We&#x27;ll uncomment the <code>usersAdapter</code> lines we originally had, and use its update functions and selectors again.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/users/usersSlice.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  createSelector</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  createEntityAdapter</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  EntityState</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@reduxjs/toolkit&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> RootState </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/app/store&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> apiSlice </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/api/apiSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> selectCurrentUsername </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/auth/authSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">interface</span><span class="token plain"> </span><span class="token class-name">User</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  id</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#a6e22e">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  name</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#a6e22e">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> usersAdapter </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#E6D874">createEntityAdapter</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">User</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> initialState </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> usersAdapter</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">getInitialState</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// This is the _same_ reference as `apiSlice`, but this has</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// the TS types updated to include the injected endpoints</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> apiSliceWithUsers </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSlice</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">injectEndpoints</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function-variable function" style="color:#E6D874">endpoints</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    getUsers</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">query</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">EntityState</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">User</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin" style="color:#a6e22e">string</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#F92672">void</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/users&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function" style="color:#E6D874">transformResponse</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">res</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> User</span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// Create a normalized state object containing all the user items</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#F92672">return</span><span class="token plain"> usersAdapter</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">setAll</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">initialState</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> res</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> useGetUsersQuery </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSliceWithUsers</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// Calling `someEndpoint.select(someArg)` generates a new selector that will return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// the query result object for a query with those parameters.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// To generate a selector for a specific query argument, call `select(theQueryArg)`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// In this case, the users query has no params, so we don&#x27;t pass anything to select()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> selectUsersResult </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSliceWithUsers</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">endpoints</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">getUsers</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">select</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> selectUsersData </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createSelector</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  selectUsersResult</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// Fall back to the empty entity state if no response yet.</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  result </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> result</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">data </span><span class="token operator" style="color:#F8F8F2">??</span><span class="token plain"> initialState</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">selectCurrentUser</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> RootState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> currentUsername </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">selectCurrentUsername</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">currentUsername</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">return</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">selectUserById</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> currentUsername</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> selectAll</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> selectAllUsers</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> selectById</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> selectUserById </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  usersAdapter</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">getSelectors</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">selectUsersData</span><span class="token punctuation" style="color:#F8F8F2">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We&#x27;ve added a <code>transformResponse</code> option to the <code>getUsers</code> endpoint. It receives the entire response data body as its argument (in this case, a <code>User[]</code> array), and should return the actual data to be cached. By calling <code>usersAdapter.setAll(initialState, responseData)</code>, it will return the standard <code>{ids: [], entities: {}}</code> normalized data structure containing all of the received items. We need to tell TS that we&#x27;re now returning that <code>EntityState&lt;User, string&gt;</code> data as the actual contents of the cache entry&#x27;s <code>data</code> field.</p>
<p>The <code>adapter.getSelectors()</code> function needs to be given an &quot;input selector&quot; so it knows where to find that normalized data. In this case, the data is nested down inside the RTK Query cache reducer, so we select the right field out of the cache state. To make things consistent, we can write a <code>selectUsersData</code> selector that falls back to the initial empty normalized state if we haven&#x27;t yet fetched the data.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="normalized-vs-document-caches">Normalized vs Document Caches<a href="#normalized-vs-document-caches" class="hash-link" aria-label="Direct link to Normalized vs Document Caches" title="Direct link to Normalized vs Document Caches">​</a></h3>
<p>It&#x27;s worth stepping back for a minute to discuss what we just did and why it matters.</p>
<p>You may have heard the term &quot;normalized cache&quot; in relation to other data fetching libraries like Apollo. It&#x27;s important to understand that <strong>RTK Query uses a &quot;document cache&quot; approach, not a &quot;normalized cache&quot;</strong>.</p>
<p>A fully normalized cache tries to deduplicate similar items across <em>all</em> queries, based on item type and ID. As an example, say that we have an API slice with <code>getTodos</code> and <code>getTodo</code> endpoints, and our components make the following queries:</p>
<ul>
<li><code>getTodos()</code></li>
<li><code>getTodos({filter: &#x27;odd&#x27;})</code></li>
<li><code>getTodo({id: 1})</code></li>
</ul>
<p>Each of these query results would include a Todo object that looks like <code>{id: 1}</code>.</p>
<p>In a fully normalized deduplicating cache, only a single copy of this Todo object would be stored. However, <strong>RTK Query saves each query result independently in the cache</strong>. So, this would result in three separate copies of this Todo being cached in the Redux store. However, if all the endpoints are consistently providing the same tags (such as <code>{type: &#x27;Todo&#x27;, id: 1}</code>), then invalidating that tag will force all the matching endpoints to refetch their data for consistency.</p>
<p>RTK Query deliberately <strong>does <em>not</em> implement a cache that would deduplicate identical items across multiple requests</strong>. There are several reasons for this:</p>
<ul>
<li>A fully normalized shared-across-queries cache is a <em>hard</em> problem to solve</li>
<li>We don&#x27;t have the time, resources, or interest in trying to solve that right now</li>
<li>In many cases, simply re-fetching data when it&#x27;s invalidated works well and is easier to understand</li>
<li>The main goal of RTKQ is to help solve the general use case of &quot;fetch some data&quot;, which is a big pain point for a lot of people</li>
</ul>
<p>In this case, we just normalized the response data for the <code>getUsers</code> endpoint, in that it&#x27;s being stored as an <code>{[id]: value}</code> lookup table. However, <strong>this is <em>not</em> the same thing as a &quot;normalized cache&quot; - we only transformed <em>how this one response is stored</em></strong> rather than deduplicating results across endpoints or requests.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="selecting-values-from-results">Selecting Values from Results<a href="#selecting-values-from-results" class="hash-link" aria-label="Direct link to Selecting Values from Results" title="Direct link to Selecting Values from Results">​</a></h3>
<p>The last component that is reading from the old <code>postsSlice</code> is <code>&lt;UserPage&gt;</code>, which filters the list of posts based on the current user. We&#x27;ve already seen that we can get the entire list of posts with <code>useGetPostsQuery()</code> and then transform it in the component, such as sorting inside of a <code>useMemo</code>. The query hooks also give us the ability to select pieces of the cached state by providing a <code>selectFromResult</code> option, and only re-render when the selected pieces change.</p>
<p>The <code>useQuery</code> hooks always take the cache key argument as the first parameter, and if you need to provide hook options, that must always be the second parameter, like <code>useSomeQuery(cacheKey, options)</code>. In this case, the <code>getUsers</code> endpoint doesn&#x27;t have any actual cache key argument. Semantically, this is the same as a cache key of <code>undefined</code>. So, in order to provide options to the hook, we have to call <code>useGetUsersQuery(undefined, options)</code>.</p>
<p>We can use <code>selectFromResult</code> to have <code>&lt;UserPage&gt;</code> read just a filtered list of posts from the cache. However, in order for <code>selectFromResult</code> to avoid unnecessary re-renders, we need to ensure that whatever data we extract is memoized correctly. To do this, we should create a new selector instance that the <code>&lt;UserPage&gt;</code> component can reuse every time it renders, so that the selector memoizes the result based on its inputs.</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/users/UserPage.tsx</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Link</span><span class="token imports punctuation" style="color:#F8F8F2">,</span><span class="token imports"> useParams </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;react-router-dom&#x27;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> createSelector </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@reduxjs/toolkit&#x27;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> </span><span class="token maybe-class-name">TypedUseQueryStateResult</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@reduxjs/toolkit/query/react&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> useAppSelector </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/app/hooks&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> useGetPostsQuery</span><span class="token imports punctuation" style="color:#F8F8F2">,</span><span class="token imports"> </span><span class="token imports maybe-class-name">Post</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/api/apiSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> selectUserById </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./usersSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// Create a TS type that represents &quot;the result value passed</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// into the `selectFromResult` function for this hook&quot;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">type</span><span class="token plain"> </span><span class="token class-name">GetPostSelectFromResultArg</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token maybe-class-name">TypedUseQueryStateResult</span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token maybe-class-name">Post</span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#a6e22e">any</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#a6e22e">any</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> selectPostsForUser </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createSelector</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">res</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token maybe-class-name">GetPostSelectFromResultArg</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> res</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">res</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token maybe-class-name">GetPostSelectFromResultArg</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> userId</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#a6e22e">string</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> userId</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> userId</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> data</span><span class="token operator" style="color:#F8F8F2">?.</span><span class="token method function property-access" style="color:#E6D874">filter</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">post </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> post</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">user</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">===</span><span class="token plain"> userId</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">UserPage</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> userId </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useParams</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> user </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useAppSelector</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">selectUserById</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> userId</span><span class="token operator" style="color:#F8F8F2">!</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// Use the same posts query, but extract only part of its data</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> postsForUser </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useGetPostsQuery</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token keyword" style="color:#F92672">undefined</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function-variable function" style="color:#E6D874">selectFromResult</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> result </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#c6cad2">// Optional: Include all of the existing result fields like `isFetching`</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token spread operator" style="color:#F8F8F2">...</span><span class="token plain">result</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#c6cad2">// Include a field called `postsForUser` in the result object,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#c6cad2">// which will be a filtered list of posts</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      postsForUser</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">selectPostsForUser</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> userId</span><span class="token operator" style="color:#F8F8F2">!</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// omit rendering logic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There&#x27;s a key difference with the memoized selector function we&#x27;ve created here. Normally, <a href="/usage/deriving-data-selectors">selectors expect the entire Redux <code>state</code> as their first argument</a>, and extract or derive a value from <code>state</code>. However, in this case we&#x27;re only dealing with the &quot;result&quot; value that is kept in the cache. The result object has a <code>data</code> field inside with the actual values we need, as well as some of the request metadata fields.</p>
<p>Because this selector is receiving something other than the usual <code>RootState</code> type as its first argument, we need to tell TS what that result value looks like. The RTK Query package exports a TS type called <code>TypedUseQueryStateResult</code> that represents &quot;the type of the <code>useQuery</code> hook return object&quot;. We can use that to declare that we expect the result to include a <code>Post[]</code> array, and then define our selector using that type.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Selectors and Memoizing Varying Arguments</div><div class="admonitionContent_BuS1"><p>As of RTK 2.x and Reselect 5.x, memoized selectors have <a href="https://reselect.js.org/api/weakMapMemoize" target="_blank" rel="noopener noreferrer">an infinite cache size</a>, so changing the arguments should still keep earlier memoized results available. If you&#x27;re using RTK 1.x or Reselect 4.x, note that memoized selectors only have a default cache size of 1. You&#x27;ll need to <a href="/usage/deriving-data-selectors#creating-unique-selector-instances">create a unique selector instance per component</a> to ensure the selector memoizes consistently when passed different arguments like IDs.</p></div></div>
<p>Our <code>selectFromResult</code> callback receives the <code>result</code> object containing the original request metadata and the <code>data</code> from the server, and should return some extracted or derived values. Because query hooks add an additional <code>refetch</code> method to whatever is returned here, <code>selectFromResult</code> should always return an object with the fields inside that you need inside.</p>
<p>Since <code>result</code> is being kept in the Redux store, we can&#x27;t mutate it - we need to return a new object. The query hook will do a &quot;shallow&quot; comparison on this returned object, and <strong>only re-render the component if one of the fields has changed</strong>. We can optimize re-renders by only returning the specific fields needed by this component - if we don&#x27;t need the rest of the metadata flags, we could omit them entirely. If you do need them, you can spread the original <code>result</code> value to include them in the output.</p>
<p>In this case, we&#x27;ll call the field <code>postsForUser</code>, and we can destructure that new field from the hook result. By calling <code>selectPostsForUser(result, userId)</code> every time, it will memoize the filtered array and only recalculate it if the fetched data or the user ID changes.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="comparing-transformation-approaches">Comparing Transformation Approaches<a href="#comparing-transformation-approaches" class="hash-link" aria-label="Direct link to Comparing Transformation Approaches" title="Direct link to Comparing Transformation Approaches">​</a></h3>
<p>We&#x27;ve now seen three different ways that we can manage transforming responses:</p>
<ul>
<li>Keep original response in cache, read full result in component and derive values</li>
<li>Keep original response in cache, read derived result with <code>selectFromResult</code></li>
<li>Transform response before storing in cache</li>
</ul>
<p>Each of these approaches can be useful in different situations. Here&#x27;s some suggestions for when you should consider using them:</p>
<ul>
<li><code>transformResponse</code>: all consumers of the endpoint want a specific format, such as normalizing the response to enable faster lookups by ID</li>
<li><code>selectFromResult</code>: some consumers of the endpoint only need partial data, such as a filtered list</li>
<li>per-component / <code>useMemo</code>: when only some specific components need to transform the cached data</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="advanced-cache-updates">Advanced Cache Updates<a href="#advanced-cache-updates" class="hash-link" aria-label="Direct link to Advanced Cache Updates" title="Direct link to Advanced Cache Updates">​</a></h2>
<p>We&#x27;ve completed updating our posts and users data, so all that&#x27;s left is working with reactions and notifications. Switching these to use RTK Query will give us a chance to try out some of the advanced techniques available for working with RTK Query&#x27;s cached data, and allow us to provide a better experience for our users.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="persisting-reactions">Persisting Reactions<a href="#persisting-reactions" class="hash-link" aria-label="Direct link to Persisting Reactions" title="Direct link to Persisting Reactions">​</a></h3>
<p>Originally, we only tracked reactions on the client side and did not persist them to the server. Let&#x27;s add a new <code>addReaction</code> mutation and use that to update the corresponding <code>Post</code> on the server every time the user clicks a reaction button.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/api/apiSlice.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> apiSlice </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createApi</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  reducerPath</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;api&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  baseQuery</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">fetchBaseQuery</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> baseUrl</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/fakeApi&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  tagTypes</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function-variable function" style="color:#E6D874">endpoints</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// omit other endpoints</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    addReaction</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">mutation</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token generic-function generic class-name">      Post</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token generic-function generic class-name">      </span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">{</span><span class="token generic-function generic class-name"> postId</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin" style="color:#a6e22e">string</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">;</span><span class="token generic-function generic class-name"> reaction</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">:</span><span class="token generic-function generic class-name"> ReactionName </span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">}</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token generic-function generic class-name">    </span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> postId</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> reaction </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        url</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">posts/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">${</span><span class="token template-string interpolation">postId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">}</span><span class="token template-string string" style="color:#a6e22e">/reactions</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        method</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// In a real app, we&#x27;d probably need to base this on user ID somehow</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// so that a user can&#x27;t do the same reaction more than once</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        body</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> reaction </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">invalidatesTags</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> type</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> id</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">postId </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  useGetPostsQuery</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  useGetPostQuery</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  useAddNewPostMutation</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  useEditPostMutation</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  useAddReactionMutation</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSlice</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Similar to our other mutations, we take some parameters and make a request to the server, with some data in the body of the request. Since this example app is small, we&#x27;ll just give the name of the reaction, and let the server increment the counter for that reaction type on this post.</p>
<p>We already know that we need to refetch this post in order to see any of the data change on the client, so we can invalidate this specific <code>Post</code> entry based on its ID.</p>
<p>With that in place, let&#x27;s update <code>&lt;ReactionButtons&gt;</code> to use this mutation.</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/posts/ReactionButtons.tsx</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> useAddReactionMutation </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/api/apiSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> </span><span class="token maybe-class-name">Post</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token maybe-class-name">ReactionName</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./postsSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> reactionEmoji</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token maybe-class-name">Record</span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token maybe-class-name">ReactionName</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#a6e22e">string</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  thumbsUp</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;👍&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  tada</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;🎉&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  heart</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;❤️&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  rocket</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;🚀&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  eyes</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;👀&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">interface</span><span class="token plain"> </span><span class="token class-name">ReactionButtonsProps</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  post</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token maybe-class-name">Post</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">ReactionButtons</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> post </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReactionButtonsProps</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token plain">addReaction</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useAddReactionMutation</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> reactionButtons </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">entries</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">reactionEmoji</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">map</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token plain">stringName</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> emoji</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#c6cad2">// Ensure TS knows this is a _specific_ string type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token class-name keyword" style="color:#F92672">const</span><span class="token plain"> reaction </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> stringName </span><span class="token keyword" style="color:#F92672">as</span><span class="token plain"> </span><span class="token maybe-class-name">ReactionName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#F92672">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;</span><span class="token tag" style="color:#F92672">button</span><span class="token tag" style="color:#F92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#F92672">          </span><span class="token tag attr-name" style="color:#a6e22e">key</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#F8F8F2">=</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">{</span><span class="token tag script language-javascript" style="color:#F92672">reaction</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">}</span><span class="token tag" style="color:#F92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#F92672">          </span><span class="token tag attr-name" style="color:#a6e22e">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#F8F8F2">=</span><span class="token tag attr-value punctuation" style="color:#F8F8F2">&quot;</span><span class="token tag attr-value" style="color:#E6D874">button</span><span class="token tag attr-value punctuation" style="color:#F8F8F2">&quot;</span><span class="token tag" style="color:#F92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#F92672">          </span><span class="token tag attr-name" style="color:#a6e22e">className</span><span class="token tag attr-value punctuation attr-equals" style="color:#F8F8F2">=</span><span class="token tag attr-value punctuation" style="color:#F8F8F2">&quot;</span><span class="token tag attr-value" style="color:#E6D874">muted-button reaction-button</span><span class="token tag attr-value punctuation" style="color:#F8F8F2">&quot;</span><span class="token tag" style="color:#F92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#F92672">          </span><span class="token tag attr-name" style="color:#a6e22e">onClick</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#F8F8F2">=</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">{</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">(</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">)</span><span class="token tag script language-javascript" style="color:#F92672"> </span><span class="token tag script language-javascript arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token tag script language-javascript" style="color:#F92672"> </span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">{</span><span class="token tag script language-javascript" style="color:#F92672"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token tag script language-javascript" style="color:#F92672">            </span><span class="token tag script language-javascript function" style="color:#E6D874">addReaction</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">(</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">{</span><span class="token tag script language-javascript" style="color:#F92672"> postId</span><span class="token tag script language-javascript operator" style="color:#F8F8F2">:</span><span class="token tag script language-javascript" style="color:#F92672"> post</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">.</span><span class="token tag script language-javascript property-access" style="color:#F92672">id</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">,</span><span class="token tag script language-javascript" style="color:#F92672"> reaction </span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">}</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">)</span><span class="token tag script language-javascript" style="color:#F92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag script language-javascript" style="color:#F92672">          </span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">}</span><span class="token tag script language-javascript punctuation" style="color:#F8F8F2">}</span><span class="token tag" style="color:#F92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#F92672">        </span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">          </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain">emoji</span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain-text"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain">post</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">reactions</span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token plain">reaction</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;/</span><span class="token tag" style="color:#F92672">button</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#F8F8F2">&lt;</span><span class="token tag" style="color:#F92672">div</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain">reactionButtons</span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token tag punctuation" style="color:#F8F8F2">&lt;/</span><span class="token tag" style="color:#F92672">div</span><span class="token tag punctuation" style="color:#F8F8F2">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let&#x27;s see this in action! Go to the main <code>&lt;PostsList&gt;</code>, and click one of the reactions to see what happens.</p>
<p><img decoding="async" loading="lazy" alt="PostsList disabled while fetching" src="/assets/images/disabled-posts-fetching-3deedbd73a9cd42a703dadc24d143094.png" width="1080" height="409" class="img_ev3q"></p>
<p>Uh-oh. The entire <code>&lt;PostsList&gt;</code> component was grayed out, because we just refetched the <em>entire</em> list of posts in response to that one post being updated. This is deliberately more visible because our mock API server is set to have a 2-second delay before responding, but even if the response is faster, this still isn&#x27;t a good user experience.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimistic-updates-for-reactions">Optimistic Updates for Reactions<a href="#optimistic-updates-for-reactions" class="hash-link" aria-label="Direct link to Optimistic Updates for Reactions" title="Direct link to Optimistic Updates for Reactions">​</a></h3>
<p>For a small update like adding a reaction, we probably don&#x27;t need to re-fetch the entire list of posts. Instead, we could try just updating the already-cached data on the client to match what we expect to have happen on the server. Also, if we update the cache immediately, the user gets instant feedback when they click the button instead of having to wait for the response to come back. <strong>This approach of updating client state right away is called an &quot;optimistic update&quot;</strong>, and it&#x27;s a common pattern in web apps.</p>
<p>RTK Query includes <strong>utilities to update the client-side cache directly</strong>. This can be combined with RTK Query&#x27;s <strong>&quot;request lifecycle&quot; methods</strong> to implement optimistic updates.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="cache-update-utilities">Cache Update Utilities<a href="#cache-update-utilities" class="hash-link" aria-label="Direct link to Cache Update Utilities" title="Direct link to Cache Update Utilities">​</a></h4>
<p>API slices have some <a href="https://redux-toolkit.js.org/rtk-query/api/created-api/api-slice-utils" target="_blank" rel="noopener noreferrer">additional methods attached, under <code>api.util</code></a>. This includes thunks for modifying the cache: <code>upsertQueryData</code> to add or replace a cache entry, and <code>updateQueryData</code> to modify a cache entry. Since these are thunks, they can be used anywhere you have access to <code>dispatch</code>.</p>
<p>In particular, the <code>updateQueryData</code> util thunk takes three arguments: the name of the endpoint to update, the same cache key argument used to identify the specific cached entry we want to update, and a callback that updates the cached data. <strong><code>updateQueryData</code> uses Immer, so you can &quot;mutate&quot; the drafted cache data the same way you would in <code>createSlice</code></strong>:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">updateQueryData example</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#E6D874">dispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  apiSlice</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">util</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">updateQueryData</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">endpointName</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> queryArg</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> draft </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// mutate `draft` here like you would in a reducer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    draft</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">value </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token number" style="color:#AE81FF">123</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>updateQueryData</code> generates an action object with a patch diff of the changes we made. When we dispatch that action, the return value from <code>dispatch</code> is a <code>patchResult</code> object. If we call <code>patchResult.undo()</code>, it automatically dispatches an action that reverses the patch diff changes.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-onquerystarted-lifecycle">The <code>onQueryStarted</code> Lifecycle<a href="#the-onquerystarted-lifecycle" class="hash-link" aria-label="Direct link to the-onquerystarted-lifecycle" title="Direct link to the-onquerystarted-lifecycle">​</a></h4>
<p>The first lifecycle method we&#x27;ll look at is <a href="https://redux-toolkit.js.org/rtk-query/api/createApi#onquerystarted" target="_blank" rel="noopener noreferrer"><strong><code>onQueryStarted</code></strong></a>. This option is available for both queries and mutations.</p>
<p>If provided, <code>onQueryStarted</code> will be called every time a new request goes out. This gives us a place to run additional logic in response to the request.</p>
<p>Similar to async thunks and listener effects, the <code>onQueryStarted</code> callback receives the query <code>arg</code> value from the request as its first argument, and a <code>lifecycleApi</code> object as the second argument. <code>lifecycleApi</code> includes the same <code>{dispatch, getState, extra, requestId}</code> values as <code>createAsyncThunk</code>. It also has a couple additional fields that are unique to this lifecycle. The most important one is <code>lifecycleApi.queryFulfilled</code>, a Promise that will resolve when the request returns, and either fulfill or reject based on the request.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="implementing-optimistic-updates">Implementing Optimistic Updates<a href="#implementing-optimistic-updates" class="hash-link" aria-label="Direct link to Implementing Optimistic Updates" title="Direct link to Implementing Optimistic Updates">​</a></h4>
<p>We can use the update utilities inside of the <code>onQueryStarted</code> lifecycle to implement either &quot;optimistic&quot; updates (updating the cache <em>before</em> the request is finished), or &quot;pessimistic&quot; updates (updating the cache <em>after</em> the request is finished).</p>
<p>We can implement the optimistic update by finding the specific <code>Post</code> entry in the <code>getPosts</code> cache, and &quot;mutating&quot; it to increment the reaction counter. We also may have a second copy of the same conceptual individual <code>Post</code> object in the <code>getPost</code> cache for that post ID also, so we need to update that cache entry if it exists as well.</p>
<p>By default, we expect that the request will succeed. In case the request fails, we can <code>await lifecycleApi.queryFulfilled</code>, catch a failure, and undo the patch changes to revert the optimistic update.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/api/apiSlice.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> apiSlice </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createApi</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  reducerPath</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;api&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  baseQuery</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">fetchBaseQuery</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> baseUrl</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/fakeApi&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  tagTypes</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token string" style="color:#a6e22e">&#x27;Post&#x27;</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function-variable function" style="color:#E6D874">endpoints</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// omit other endpoints</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    addReaction</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">mutation</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token generic-function generic class-name">      Post</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token generic-function generic class-name">      </span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">{</span><span class="token generic-function generic class-name"> postId</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin" style="color:#a6e22e">string</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">;</span><span class="token generic-function generic class-name"> reaction</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">:</span><span class="token generic-function generic class-name"> ReactionName </span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">}</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token generic-function generic class-name">    </span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> postId</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> reaction </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        url</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">posts/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">${</span><span class="token template-string interpolation">postId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">}</span><span class="token template-string string" style="color:#a6e22e">/reactions</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        method</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// In a real app, we&#x27;d probably need to base this on user ID somehow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// so that a user can&#x27;t do the same reaction more than once</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        body</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> reaction </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#c6cad2">// The `invalidatesTags` line has been removed,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#c6cad2">// since we&#x27;re now doing optimistic updates</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#F92672">async</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">onQueryStarted</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> postId</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> reaction </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> lifecycleApi</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// `updateQueryData` requires the endpoint name and cache key arguments,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// so it knows which piece of cache state to update</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> getPostsPatchResult </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> lifecycleApi</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">dispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          apiSlice</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">util</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">updateQueryData</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token string" style="color:#a6e22e">&#x27;getPosts&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">undefined</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> draft </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token comment" style="color:#c6cad2">// The `draft` is Immer-wrapped and can be &quot;mutated&quot; like in createSlice</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> post </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> draft</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">find</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">post </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> post</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">id </span><span class="token operator" style="color:#F8F8F2">===</span><span class="token plain"> postId</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#F92672">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">post</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">              post</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">reactions</span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token plain">reaction</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token operator" style="color:#F8F8F2">++</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// We also have another copy of the same data in the `getPost` cache</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// entry for this post ID, so we need to update that as well</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> getPostPatchResult </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> lifecycleApi</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">dispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          apiSlice</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">util</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">updateQueryData</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token string" style="color:#a6e22e">&#x27;getPost&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> postId</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> draft </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            draft</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">reactions</span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token plain">reaction</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token operator" style="color:#F8F8F2">++</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#F92672">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword" style="color:#F92672">await</span><span class="token plain"> lifecycleApi</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">queryFulfilled</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          getPostsPatchResult</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">undo</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          getPostPatchResult</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">undo</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For this case, we&#x27;ve also removed the <code>invalidatesTags</code> line we&#x27;d just added, since we <em>don&#x27;t</em> want to refetch the posts when we click a reaction button.</p>
<p>Now, if we click several times on a reaction button quickly, we should see the number increment in the UI each time. If we look at the Network tab, we&#x27;ll also see each individual request go out to the server as well.</p>
<p>Sometimes mutation requests come back with meaningful data in the server response, such as a final item ID that should replace a temporary client-side ID, or other related data. If we did the <code>const res = await lifecycleApi.queryFulfilled</code> first, we could then use the data from the response after that to apply cache updates as a &quot;pessimistic&quot; update.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="streaming-updates-for-notifications">Streaming Updates for Notifications<a href="#streaming-updates-for-notifications" class="hash-link" aria-label="Direct link to Streaming Updates for Notifications" title="Direct link to Streaming Updates for Notifications">​</a></h3>
<p>Our final feature is the notifications tab. When we originally built this feature in <a href="/tutorials/essentials/part-6-performance-normalization#adding-notifications">Part 6</a>, we said that &quot;in a real app, the server would push updates to our client every time something happens&quot;. We initially faked that feature by adding a &quot;Refresh Notifications&quot; button, and having it make an HTTP <code>GET</code> request for more notifications entries.</p>
<p>It&#x27;s common for apps to make an <em>initial</em> request to fetch data from the server, and then open up a Websocket connection to receive additional updates over time. RTK Query&#x27;s lifecycle methods give us room to implement that kind of &quot;streaming updates&quot; to cached data.</p>
<p>We&#x27;ve already seen the <code>onQueryStarted</code> lifecycle that let us implement optimistic (or pessimistic) updates. Additionally, <strong>RTK Query provides an <code>onCacheEntryAdded</code> endpoint lifecycle handler, which is a good place to implement streaming updates</strong>. We&#x27;ll use that capability to implement a more realistic approach to managing notifications.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-oncacheentryadded-lifecycle">The <code>onCacheEntryAdded</code> Lifecycle<a href="#the-oncacheentryadded-lifecycle" class="hash-link" aria-label="Direct link to the-oncacheentryadded-lifecycle" title="Direct link to the-oncacheentryadded-lifecycle">​</a></h4>
<p>Like <code>onQueryStarted</code>, the <a href="https://redux-toolkit.js.org/rtk-query/api/createApi#oncacheentryadded" target="_blank" rel="noopener noreferrer"><strong><code>onCacheEntryAdded</code></strong></a> lifecycle method is available for both queries and mutations.</p>
<p><code>onCacheEntryAdded</code> will be called any time a new cache entry (endpoint + serialized query arg) is added to the cache. This means it will run less often than <code>onQueryStarted</code>, which runs whenever a request happens.</p>
<p>Similar to <code>onQueryStarted</code>, <code>onCacheEntryAdded</code> receives two parameters. The first is the usual query <code>args</code> value. The second is a slightly different <code>lifecycleApi</code> that has <code>{dispatch, getState, extra, requestId}</code>, as well as an <code>updateCachedData</code> util, an alternate form of <code>api.util.updateQueryData</code> that already knows the right endpoint name and query args to use and does the dispatching for you.</p>
<p>There&#x27;s also two additional Promises that can be waited on:</p>
<ul>
<li><code>cacheDataLoaded</code>: resolves with the first cached value received, and is typically used to wait for an actual value to be in the cache before doing more logic</li>
<li><code>cacheEntryRemoved </code>: resolves when this cache entry is removed (ie, there are no more subscribers and the cache entry has been garbage-collected)</li>
</ul>
<p>As long as 1+ subscribers for the data are still active, the cache entry is kept alive. When the number of subscribers goes to 0 and the cache lifetime timer expires, the cache entry will be removed, and <code>cacheEntryRemoved</code> will resolve. Typically, the usage pattern is:</p>
<ul>
<li><code>await cacheDataLoaded</code> right away</li>
<li>Create a server-side data subscription like a Websocket</li>
<li>When an update is received, use <code>updateCachedData</code> to &quot;mutate&quot; the cached values based on the update</li>
<li><code>await cacheEntryRemoved</code> at the end</li>
<li>Clean up subscriptions afterwards</li>
</ul>
<p>This makes <code>onCacheEntryAdded</code> a good place to put longer-running logic that should keep going as long as the UI needs this particular piece of data. A good example might be a chat app that needs to fetch initial messages for a chat channel, uses a Websocket subscription to receive additional messages over time, and disconnects the Websocket when the user closes the channel.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="fetching-notifications">Fetching Notifications<a href="#fetching-notifications" class="hash-link" aria-label="Direct link to Fetching Notifications" title="Direct link to Fetching Notifications">​</a></h4>
<p>We&#x27;ll need to break this work into a few steps.</p>
<p>First, we&#x27;ll set up a new endpoint for notifications, and add a replacement for the <code>fetchNotificationsWebsocket</code> thunk that will trigger our mock backend to send back notifications via a websocket instead of as an HTTP request.</p>
<p>We&#x27;ll inject the <code>getNotifications</code> endpoint in <code>notificationsSlice</code> like we did with <code>getUsers</code>, just to show it&#x27;s possible.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/notifications/notificationsSlices.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> createEntityAdapter</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> createSlice </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@reduxjs/toolkit&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> client </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/api/client&#x27;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> forceGenerateNotifications </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/api/server&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> AppThunk</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> RootState </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/app/store&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> createAppAsyncThunk </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/app/withTypes&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> apiSlice </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/api/apiSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// omit types and `fetchNotifications` thunk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> apiSliceWithNotifications </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSlice</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">injectEndpoints</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function-variable function" style="color:#E6D874">endpoints</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    getNotifications</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">query</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">ServerNotification</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">[</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">]</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#F92672">void</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/notifications&#x27;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> useGetNotificationsQuery </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSliceWithNotifications</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>getNotifications</code> is a standard query endpoint that will store the <code>ServerNotification</code> objects we received from the server.</p>
<p>Then, in <code>&lt;Navbar&gt;</code>, we can use the new query hook to automatically fetch some notifications. When we do that, we&#x27;re only getting back <code>ServerNotification</code> objects, not the <code>ClientNotification</code> objects with the additional <code>{read, isNew}</code> fields we&#x27;ve been adding, so we&#x27;ll have to temporarily disable the check for <code>notification.new</code>:</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/notifications/NotificationsList.tsx</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#c6cad2">// omit other imports</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> allNotificationsRead</span><span class="token imports punctuation" style="color:#F8F8F2">,</span><span class="token imports"> useGetNotificationsQuery </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./notificationsSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">NotificationsList</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> dispatch </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useAppDispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> data</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> notifications </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useGetNotificationsQuery</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#E6D874">useLayoutEffect</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#E6D874">dispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token function" style="color:#E6D874">allNotificationsRead</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> renderedNotifications </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> notifications</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">map</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">notification</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> notificationClassname </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">classnames</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token string" style="color:#a6e22e">&#x27;notification&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#c6cad2">// new: notification.isNew,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// omit rendering</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we go into the &quot;Notifications&quot; tab, we should see a few entries show up, but none of them will be colored to indicate they&#x27;re new. Meanwhile, if we click the &quot;Refresh Notifications&quot; button, we&#x27;ll see the &quot;unread notifications&quot; counter keep increasing. That&#x27;s because of two things. The button is still triggering the original <code>fetchNotifications</code> thunk that stores entries in the <code>state.notifications</code> slice. Also, the <code>&lt;NotificationsList&gt;</code> component isn&#x27;t even re-rendering (it relies on the cached data from the <code>useGetNotificationsQuery</code> hook, not the <code>state.notifications</code> slice), and so the <code>useLayoutEffect</code> isn&#x27;t running or dispatching <code>allNotificationsRead</code>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tracking-client-side-state">Tracking Client-Side State<a href="#tracking-client-side-state" class="hash-link" aria-label="Direct link to Tracking Client-Side State" title="Direct link to Tracking Client-Side State">​</a></h4>
<p>The next step is to rethink how we track &quot;read&quot; status for notifications.</p>
<p>Previously, we were taking the <code>ServerNotification</code> objects we fetched from the <code>fetchNotifications</code> thunk, adding the <code>{read, isNew}</code> fields in the reducer, and saving those objects. Now, we&#x27;re saving the <code>ServerNotification</code> objects in the RTK Query cache.</p>
<p>We <em>could</em> do more manual cache updates. We could use <code>transformResponse</code> to add the additional fields, then do some work to modify the cache itself as the user views the notifications.</p>
<p>Instead, we&#x27;re going to try a different form of what we were already doing: keeping track of the read status inside of the <code>notificationsSlice</code>.</p>
<p>Conceptually, what we really want to do is track the <code>{read, isNew}</code> status of each notification item. We could do that in the slice and keep a corresponding &quot;metadata&quot; entry for each notification we&#x27;ve received, <em>if</em> we had a way to know when the query hook has fetched notifications and had access to the notification IDs.</p>
<p>Fortunately, we can do that! Because RTK Query is built out of standard Redux Toolkit pieces like <code>createAsyncThunk</code>, it&#x27;s dispatching a <code>fulfilled</code> action with the results each time a request finishes. We just need a way to listen to that in the <code>notificationsSlice</code>, and we know that <code>createSlice.extraReducers</code> is where we&#x27;d need to handle that action.</p>
<p>But what are we listening for? Because this is an RTKQ endpoint, we don&#x27;t have access to the <code>asyncThunk.fulfilled/pending</code> action creators, so we can&#x27;t just pass those to <code>builder.addCase()</code>.</p>
<p>RTK Query endpoints expose a <strong><code>matchFulfilled</code> matcher function</strong>, which we can use inside of <code>extraReducers</code> to listen to the <code>fulfilled</code> actions for that endpoint. (Note that we need to change from <code>builder.addCase()</code> to <code>builder.addMatcher()</code>).</p>
<p>So, we&#x27;re going to change <code>ClientNotification</code> to be a new <code>NotificationMetadata</code> type, listen for the <code>getNotifications</code> query actions, and store the &quot;just metadata&quot; objects in the slice instead of the entire notifications.</p>
<p>As part of that, we&#x27;re going to rename <code>notificationsAdapter</code> to <code>metadataAdapter</code>, and replace all mentions of <code>notification</code> variables with <code>metadata</code> for clarity. This may look like a lot of changes, but it&#x27;s mostly just renaming variables.</p>
<p>We&#x27;ll also export the entity adapter <code>selectEntities</code> selector as <code>selectMetadataEntities</code>. We&#x27;re going to need to look up these metadata objects by ID in the UI, and it will be easier to do that if we have the lookup table available in the component.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/notifications/notificationsSlice.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#c6cad2">// omit imports and thunks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// Replaces `ClientNotification`, since we just need these fields</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">interface</span><span class="token plain"> </span><span class="token class-name">NotificationMetadata</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// Add an `id` field, since this is now a standalone object</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  id</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#a6e22e">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  read</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#a6e22e">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  isNew</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#a6e22e">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> fetchNotifications </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createAppAsyncThunk</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token string" style="color:#a6e22e">&#x27;notifications/fetchNotifications&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">_unused</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> thunkApi</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// Deleted timestamp lookups - we&#x27;re about to remove this thunk anyway</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> response </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">get</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">ServerNotification</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">[</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">]</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">/fakeApi/notifications</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">return</span><span class="token plain"> response</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">data</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// Renamed from `notificationsAdapter`, and we don&#x27;t need sorting</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> metadataAdapter </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#E6D874">createEntityAdapter</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">NotificationMetadata</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> initialState </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> metadataAdapter</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">getInitialState</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> notificationsSlice </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createSlice</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  name</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;notifications&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  initialState</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  reducers</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#E6D874">allNotificationsRead</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#c6cad2">// Rename to `metadata`</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      Object</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">values</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">entities</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">forEach</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">metadata </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        metadata</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">read </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token boolean" style="color:#AE81FF">true</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#E6D874">extraReducers</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">builder</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// Listen for the endpoint `matchFulfilled` action with `addMatcher`</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">addMatcher</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      apiSliceWithNotifications</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">endpoints</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">getNotifications</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">matchFulfilled</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> action</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// Add client-side metadata for tracking new notifications</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> notificationsMetadata</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> NotificationMetadata</span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          action</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">payload</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">map</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">notification </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token comment" style="color:#c6cad2">// Give the metadata object the same ID as the notification</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            id</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> notification</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            read</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token boolean" style="color:#AE81FF">false</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            isNew</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token boolean" style="color:#AE81FF">true</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// Rename to `metadata`</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        Object</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">values</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">entities</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">forEach</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">metadata </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token comment" style="color:#c6cad2">// Any notifications we&#x27;ve read are no longer new</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token class-name">metadata</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">isNew </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">!</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">read</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        metadataAdapter</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">upsertMany</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> notificationsMetadata</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> allNotificationsRead </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> notificationsSlice</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">actions</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">default</span><span class="token plain"> notificationsSlice</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">reducer</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// Rename the selector</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  selectAll</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> selectAllNotificationsMetadata</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  selectEntities</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> selectMetadataEntities</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> metadataAdapter</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">getSelectors</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> RootState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> state</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">notifications</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">selectUnreadNotificationsCount</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> RootState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> allMetadata </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">selectAllNotificationsMetadata</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> unreadNotifications </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> allMetadata</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">filter</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">metadata </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">!</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">return</span><span class="token plain"> unreadNotifications</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">length</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then we can read that metadata lookup table into <code>&lt;NotificationsList&gt;</code>, and look up the right metadata object for each notification that we&#x27;re rendering, and re-enable the <code>isNew</code> check to show the right styling:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/notifications/NotificationsList.tsx</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> allNotificationsRead</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> useGetNotificationsQuery</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> selectMetadataEntities </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./notificationsSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">NotificationsList</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> dispatch </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useAppDispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> data</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> notifications </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useGetNotificationsQuery</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> notificationsMetadata </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useAppSelector</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">selectMetadataEntities</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#E6D874">useLayoutEffect</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#E6D874">dispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token function" style="color:#E6D874">allNotificationsRead</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> renderedNotifications </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> notifications</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">map</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">notification</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#c6cad2">// Get the metadata object matching this notification</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> metadata </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> notificationsMetadata</span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token plain">notification</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> notificationClassname </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">classnames</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token string" style="color:#a6e22e">&#x27;notification&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#c6cad2">// re-enable the `isNew` check for styling</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#F92672">new</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> metadata</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">isNew</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// omit rendering</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now if we look at the &quot;Notifications&quot; tab, the new notifications are styled correctly... but we still don&#x27;t get any <em>more</em> notifications, nor do these get marked as read.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="pushing-notifications-via-websocket">Pushing Notifications Via Websocket<a href="#pushing-notifications-via-websocket" class="hash-link" aria-label="Direct link to Pushing Notifications Via Websocket" title="Direct link to Pushing Notifications Via Websocket">​</a></h4>
<p>We&#x27;ve got a couple more steps to do to finish switching over to getting more notifications via server push.</p>
<p>The next step is to switch our &quot;Refresh Notifications&quot; button from dispatching an async thunk to fetch via HTTP request, to forcing the mock backend to send notifications via a websocket.</p>
<p>Our <code>src/api/server.ts</code> file has a mock Websocket server already configured, similar to the mock HTTP server. Since we don&#x27;t have a real backend (or other users!), we still need to manually tell the mock server <em>when</em> to send new notifications, so we&#x27;ll continue faking that by having a button we click to force the update. To do this, <code>server.ts</code> exports a function called <code>forceGenerateNotifications</code>, which will force the backend to push out some notification entries via that websocket.</p>
<p>We&#x27;re going to replace the <code>fetchNotifications</code> async thunk with a <code>fetchNotificationsWebsocket</code> thunk. <code>fetchNotificationsWebsocket</code> is doing the same kind of work as the existing <code>fetchNotifications</code> async thunk. However, in this case we&#x27;re not making an actual HTTP request, so there&#x27;s no <code>await</code> call and no payload to return. We&#x27;re just calling a function that <code>server.ts</code> exported specifically to let us fake server-side push notifications.</p>
<p>Because of that, <code>fetchNotificationsWebsocket</code> doesn&#x27;t even need to use <code>createAsyncThunk</code>. It&#x27;s just a normal handwritten thunk, so we can use the <code>AppThunk</code> type to describe the type of the thunk function and have correct types for <code>(dispatch, getState)</code>.</p>
<p>In order to implement the &quot;latest timestamp&quot; check, we do need to add selectors that let us read from the notifications cache entry as well. We&#x27;ll use the same pattern we saw with the users slice.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/notifications/notificationsSlice.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  createEntityAdapter</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  createSlice</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  createSelector</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@reduxjs/toolkit&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> forceGenerateNotifications </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/api/server&#x27;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> AppThunk</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> RootState </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/app/store&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> apiSlice </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/api/apiSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// omit types and API slice setup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> useGetNotificationsQuery </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSliceWithNotifications</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> fetchNotificationsWebsocket </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> AppThunk </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">dispatch</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> getState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> allNotifications </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">selectNotificationsData</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token function" style="color:#E6D874">getState</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token plain">latestNotification</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> allNotifications</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> latestTimestamp </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> latestNotification</span><span class="token operator" style="color:#F8F8F2">?.</span><span class="token plain">date </span><span class="token operator" style="color:#F8F8F2">??</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;&#x27;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// Hardcode a call to the mock server to simulate a server push scenario over websockets</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#E6D874">forceGenerateNotifications</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">latestTimestamp</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> emptyNotifications</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> ServerNotification</span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> selectNotificationsResult </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  apiSliceWithNotifications</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">endpoints</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">getNotifications</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">select</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> selectNotificationsData </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createSelector</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  selectNotificationsResult</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  notificationsResult </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> notificationsResult</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">data </span><span class="token operator" style="color:#F8F8F2">??</span><span class="token plain"> emptyNotifications</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// omit slice and selectors</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then we can swap <code>&lt;Navbar&gt;</code> to dispatch <code>fetchNotificationsWebsocket</code> instead:</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">components/Navbar.tsx</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token imports">  fetchNotificationsWebsocket</span><span class="token imports punctuation" style="color:#F8F8F2">,</span><span class="token imports"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token imports">  selectUnreadNotificationsCount</span><span class="token imports punctuation" style="color:#F8F8F2">,</span><span class="token imports"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token imports"></span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/notifications/notificationsSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> selectCurrentUser </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/users/usersSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">UserIcon</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./UserIcon&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">Navbar</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// omit hooks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">isLoggedIn</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">onLogoutClicked</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function" style="color:#E6D874">dispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token function" style="color:#E6D874">logout</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">fetchNewNotifications</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function" style="color:#E6D874">dispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token function" style="color:#E6D874">fetchNotificationsWebsocket</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Almost there! We&#x27;re fetching initial notifications via RTK Query, tracking read status on the client side, and we&#x27;ve got the infrastructure set up to force new notifications via a websocket. But, <strong>if we click &quot;Refresh Notifications&quot; now, it will throw an error - we don&#x27;t have the websocket handling implemented yet!</strong></p>
<p>So, let&#x27;s implement the actual streaming updates logic.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="implementing-streaming-updates">Implementing Streaming Updates<a href="#implementing-streaming-updates" class="hash-link" aria-label="Direct link to Implementing Streaming Updates" title="Direct link to Implementing Streaming Updates">​</a></h4>
<p>For this app, conceptually we want to check for notifications as soon as the user logs in, and immediately start listening for all future incoming notifications updates. If the user logs out, we should stop listening.</p>
<p>We know that the <code>&lt;Navbar&gt;</code> is only rendered after the user logs in, and it stays rendered the whole time. So, that would be a good place to keep the cache subscription alive. We can do that by rendering the <code>useGetNotificationsQuery()</code> hook in that component.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">components/Navbar.tsx</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#c6cad2">// omit other imports</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  fetchNotificationsWebsocket</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  selectUnreadNotificationsCount</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  useGetNotificationsQuery</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@/features/notifications/notificationsSlice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">Navbar</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> dispatch </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useAppDispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> user </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">useAppSelector</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">selectCurrentUser</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// Trigger initial fetch of notifications and keep the websocket open to receive updates</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#E6D874">useGetNotificationsQuery</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// omit rest of the component</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The last step is to actually add the <code>onCacheEntryAdded</code> lifecycle handler to our <code>getNotifications</code> endpoint, and add the logic for working with the websocket.</p>
<p>In this case, we&#x27;re going to create a new websocket, subscribe to incoming messages from the socket, read the notifications from those messages, and update the RTKQ cache entry with the additional data. This is similar conceptually to what we did with the optimistic updates in <code>onQueryStarted</code>.</p>
<p>There&#x27;s one other issue we&#x27;ll run into here. If we&#x27;re receiving incoming notifications via websocket, there isn&#x27;t an explicit &quot;request succeeded&quot; action being dispatched, yet we still need to create new notification metadata entries for all of the incoming notifications.</p>
<p>We&#x27;ll address this by creating a specific new Redux action type that will be used just to signal that &quot;we&#x27;ve received more notifications&quot;, and dispatch that from within the websocket handler. Then we can update the <code>notificationsSlice</code> to listen for <em>both</em> the endpoint action and this other action using the <code>isAnyOf</code> matcher utility, and do the same metadata logic in both cases.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">features/notifications/notificationsSlice.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  createEntityAdapter</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  createSlice</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  createSelector</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  createAction</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  isAnyOf</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;@reduxjs/toolkit&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// omit imports and other code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> notificationsReceived </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#E6D874">createAction</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">ServerNotification</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">[</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">]</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token string" style="color:#a6e22e">&#x27;notifications/notificationsReceived&#x27;</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> apiSliceWithNotifications </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSlice</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">injectEndpoints</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function-variable function" style="color:#E6D874">endpoints</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    getNotifications</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token generic-function function" style="color:#E6D874">query</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&lt;</span><span class="token generic-function generic class-name">ServerNotification</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">[</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">]</span><span class="token generic-function generic class-name punctuation" style="color:#F8F8F2">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#F92672">void</span><span class="token generic-function generic class-name operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token function-variable function" style="color:#E6D874">query</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;/notifications&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#F92672">async</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">onCacheEntryAdded</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">arg</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> lifecycleApi</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// create a websocket connection when the cache subscription starts</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> ws </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">new</span><span class="token plain"> </span><span class="token class-name">WebSocket</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token string" style="color:#a6e22e">&#x27;ws://localhost&#x27;</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#F92672">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token comment" style="color:#c6cad2">// wait for the initial query to resolve before proceeding</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword" style="color:#F92672">await</span><span class="token plain"> lifecycleApi</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">cacheDataLoaded</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token comment" style="color:#c6cad2">// when data is received from the socket connection to the server,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token comment" style="color:#c6cad2">// update our query result with the received message</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#E6D874">listener</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">event</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> MessageEvent</span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token builtin" style="color:#a6e22e">string</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> message</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">              type</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;notifications&#x27;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">              payload</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> ServerNotification</span><span class="token punctuation" style="color:#F8F8F2">[</span><span class="token punctuation" style="color:#F8F8F2">]</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token constant" style="color:#F92672">JSON</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">parse</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#F92672">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">type</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token keyword" style="color:#F92672">case</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;notifications&#x27;</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">                lifecycleApi</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">updateCachedData</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">draft </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">                  </span><span class="token comment" style="color:#c6cad2">// Insert all received notifications from the websocket</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">                  </span><span class="token comment" style="color:#c6cad2">// into the existing RTKQ cache array</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">                  draft</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">push</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token operator" style="color:#F8F8F2">...</span><span class="token plain">message</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">payload</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">                  draft</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">sort</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> b</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">date</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">localeCompare</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">date</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token comment" style="color:#c6cad2">// Dispatch an additional action so we can track &quot;read&quot; state</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">                lifecycleApi</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">dispatch</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token function" style="color:#E6D874">notificationsReceived</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">payload</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#F92672">break</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token keyword" style="color:#F92672">default</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#F92672">break</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          ws</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">addEventListener</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token string" style="color:#a6e22e">&#x27;message&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> listener</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token comment" style="color:#c6cad2">// no-op in case `cacheEntryRemoved` resolves before `cacheDataLoaded`,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token comment" style="color:#c6cad2">// in which case `cacheDataLoaded` will throw</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// cacheEntryRemoved will resolve when the cache subscription is no longer active</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#F92672">await</span><span class="token plain"> lifecycleApi</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">cacheEntryRemoved</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#c6cad2">// perform cleanup steps once the `cacheEntryRemoved` promise resolves</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">        ws</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">close</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> useGetNotificationsQuery </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> apiSliceWithNotifications</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> matchNotificationsReceived </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">isAnyOf</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  notificationsReceived</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">  apiSliceWithNotifications</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">endpoints</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">getNotifications</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token plain">matchFulfilled</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// omit other code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> notificationsSlice </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createSlice</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  name</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;notifications&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  initialState</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  reducers</span><span class="token operator" style="color:#F8F8F2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> </span><span class="token comment" style="color:#c6cad2">/* omit reducers */</span><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#E6D874">extraReducers</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">builder</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#f8f8f2"><span class="token plain">    builder</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token function" style="color:#E6D874">addMatcher</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">matchNotificationsReceived</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> action</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">     </span><span class="token comment" style="color:#c6cad2">// omit logic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When the cache entry is added, we create a new <code>WebSocket</code> instance that will connect to the mock server backend.</p>
<p>We wait for the <code>lifecycleApi.cacheDataLoaded</code> Promise to resolve, at which point we know that the request has completed and we have actual data available.</p>
<p>We need to subscribe to incoming messages from the websocket. Our callback will receive a websocket <code>MessageEvent</code>, and we know that <code>event.data</code> will be a string containing the JSON-serialized notifications data from the backend.</p>
<p>When we receive that message, we parse the contents, and confirm that the parsed object matches the message type that we&#x27;re looking for. If so, we call <code>lifecycleApi.updateCachedData()</code>, add all the new notifications to the existing cache entry, and re-sort it to make sure they&#x27;re in the correct order.</p>
<p>Finally, we can also wait for the <code>lifecycleApi.cacheEntryRemoved</code> promise to know when we need to close the websocket and clean up.</p>
<p>Note that it&#x27;s not <em>required</em> that we create the websocket here in the lifecycle method. Depending on the app structure, you might have created it earlier in the app setup process, and it might be living in another module file or in its own Redux middleware. What actually matters here is that we&#x27;re using the <code>onCacheEntryAdded</code> lifecycle to know when to start listening for incoming data, inserting the results into the cache entry, and cleaning up when the cache entry goes away.</p>
<p>And that&#x27;s it! Now when we click &quot;Refresh Notifications&quot;, we should see the unread notifications count increase, and clicking over to the &quot;Notifications&quot; tab should highlight read and unread notifications appropriately.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cleanup">Cleanup<a href="#cleanup" class="hash-link" aria-label="Direct link to Cleanup" title="Direct link to Cleanup">​</a></h3>
<p>As a final step, we can do some additional cleanup. The actual <code>createSlice</code> call in <code>postsSlice.ts</code> is no longer being used, so we can delete the slice object and its associated selectors + types, then remove <code>postsReducer</code> from the Redux store. We&#x27;ll leave the <code>addPostsListeners</code> function and the types there, since that&#x27;s a reasonable place for that code.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-youve-learned">What You&#x27;ve Learned<a href="#what-youve-learned" class="hash-link" aria-label="Direct link to What You&#x27;ve Learned" title="Direct link to What You&#x27;ve Learned">​</a></h2>
<p>With that, we&#x27;ve finished converting our application over to use RTK Query! All of the data fetching has been switched over to use RTKQ, and we&#x27;ve improved the user experience by adding optimistic updates and streaming updates.</p>
<p>As we&#x27;ve seen, RTK Query includes some powerful options for controlling how we manage cached data. While you may not need all of these options right away, they provide flexibility and key capabilities to help implement specific application behaviors.</p>
<p>Let&#x27;s take one last look at the whole application in action:</p>
<iframe class="codesandbox" src="https://codesandbox.io/embed/github/reduxjs/redux-essentials-example-app/tree/ts-checkpoint-6-rtkqConversion?fontsize=14&amp;hidenavigation=1&amp;theme=dark&amp;runonclick=1" title="redux-essentials-example-app" allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Summary</div><div class="admonitionContent_BuS1"><ul>
<li><strong>Specific cache tags can be used for finer-grained cache invalidation</strong>
<ul>
<li>Cache tags can be either <code>&#x27;Post&#x27;</code> or <code>{type: &#x27;Post&#x27;, id}</code></li>
<li>Endpoints can provide or invalidate cache tags based on results and arg cache keys</li>
</ul>
</li>
<li><strong>RTK Query&#x27;s APIs are UI-agnostic and can be used outside of React</strong>
<ul>
<li>Endpoint objects include functions for initiating requests, generating result selectors, and matching request action objects</li>
</ul>
</li>
<li><strong>Responses can be transformed in different ways as needed</strong>
<ul>
<li>Endpoints can define a <code>transformResponse</code> callback to modify the data before caching</li>
<li>Hooks can be given a <code>selectFromResult</code> option to extract/transform data</li>
<li>Components can read an entire value and transform with <code>useMemo</code></li>
</ul>
</li>
<li><strong>RTK Query has advanced options for manipulating cached data for better user experience</strong>
<ul>
<li>The <code>onQueryStarted</code> lifecycle can be used for optimistic updates by updating cache immediately before a request returns</li>
<li>The <code>onCacheEntryAdded</code> lifecycle can be used for streaming updates by updating cache over time based on server push connections</li>
<li>RTKQ endpoints have a <code>matchFulfilled</code> matcher that can be used inside to listen for RTKQ endpoint actions and run additional logic, like updating a slice&#x27;s state</li>
</ul>
</li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-next">What&#x27;s Next?<a href="#whats-next" class="hash-link" aria-label="Direct link to What&#x27;s Next?" title="Direct link to What&#x27;s Next?">​</a></h2>
<p>Congratulations, <strong>you&#x27;ve completed the Redux Essentials tutorial!</strong> You should now have a solid understanding of what Redux Toolkit and React-Redux are, how to write and organize Redux logic, Redux data flow and usage with React, and how to use APIs like <code>configureStore</code> and <code>createSlice</code>. You should also know how RTK Query can simplify the process of fetching and using cached data.</p>
<p>For more details on using RTK Query, see <a href="https://redux-toolkit.js.org/rtk-query/usage/queries" target="_blank" rel="noopener noreferrer">the RTK Query usage guide docs</a> and <a href="https://redux-toolkit.js.org/rtk-query/api/createApi" target="_blank" rel="noopener noreferrer">API reference</a>.</p>
<p>The concepts we&#x27;ve covered in this tutorial so far should be enough to get you started building your own applications using React and Redux. Now&#x27;s a great time to try working on a project yourself to solidify these concepts and see how they work in practice. If you&#x27;re not sure what kind of a project to build, see <a href="https://github.com/florinpop17/app-ideas" target="_blank" rel="noopener noreferrer">this list of app project ideas</a> for some inspiration.</p>
<p>The Redux Essentials tutorial is focused on &quot;how to use Redux correctly&quot;, rather than &quot;how it works&quot; or &quot;why it works this way&quot;. In particular, Redux Toolkit is a higher-level set of abstractions and utilities, and it&#x27;s helpful to understand what the abstractions in RTK are actually doing for you. Reading through the <a href="/tutorials/fundamentals/part-1-overview">&quot;Redux Fundamentals&quot; tutorial</a> will help you understand how to write Redux code &quot;by hand&quot;, and why we recommend Redux Toolkit as the default way to write Redux logic.</p>
<p>The <a href="/usage/">Using Redux</a> section has information on a number of important concepts, like <a href="/usage/structuring-reducers/structuring-reducers">how to structure your reducers</a>, and <a href="/style-guide/">our Style Guide page</a> has important information on our recommended patterns and best practices.</p>
<p>If you&#x27;d like to know more about <em>why</em> Redux exists, what problems it tries to solve, and how it&#x27;s meant to be used, see Redux maintainer Mark Erikson&#x27;s posts on <a href="https://blog.isquaredsoftware.com/2017/05/idiomatic-redux-tao-of-redux-part-1/" target="_blank" rel="noopener noreferrer">The Tao of Redux, Part 1: Implementation and Intent</a> and <a href="https://blog.isquaredsoftware.com/2017/05/idiomatic-redux-tao-of-redux-part-2/" target="_blank" rel="noopener noreferrer">The Tao of Redux, Part 2: Practice and Philosophy</a>.</p>
<p>If you&#x27;re looking for help with Redux questions, come join <a href="https://www.reactiflux.com" target="_blank" rel="noopener noreferrer">the <code>#redux</code> channel in the Reactiflux server on Discord</a>.</p>
<p><strong>Thanks for reading through this tutorial, and we hope you enjoy building applications with Redux!</strong></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/reduxjs/redux/edit/master/website/../docs/tutorials/essentials/part-8-rtk-query-advanced.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-11-27T19:30:48.000Z" itemprop="dateModified">Nov 27, 2025</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/tutorials/essentials/part-7-rtk-query-basics"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">RTK Query Basics</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/tutorials/fundamentals/part-1-overview"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Redux Overview</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#editing-posts" class="table-of-contents__link toc-highlight">Editing Posts</a><ul><li><a href="#updating-the-edit-post-form" class="table-of-contents__link toc-highlight">Updating the Edit Post Form</a></li><li><a href="#cache-data-subscription-lifetimes" class="table-of-contents__link toc-highlight">Cache Data Subscription Lifetimes</a></li><li><a href="#invalidating-specific-items" class="table-of-contents__link toc-highlight">Invalidating Specific Items</a></li><li><a href="#updating-toast-display" class="table-of-contents__link toc-highlight">Updating Toast Display</a></li></ul></li><li><a href="#managing-users-data" class="table-of-contents__link toc-highlight">Managing Users Data</a><ul><li><a href="#fetching-users-manually" class="table-of-contents__link toc-highlight">Fetching Users Manually</a></li><li><a href="#selecting-users-data" class="table-of-contents__link toc-highlight">Selecting Users Data</a></li><li><a href="#splitting-and-injecting-endpoints" class="table-of-contents__link toc-highlight">Splitting and Injecting Endpoints</a></li></ul></li><li><a href="#manipulating-response-data" class="table-of-contents__link toc-highlight">Manipulating Response Data</a><ul><li><a href="#transforming-responses" class="table-of-contents__link toc-highlight">Transforming Responses</a></li><li><a href="#normalized-vs-document-caches" class="table-of-contents__link toc-highlight">Normalized vs Document Caches</a></li><li><a href="#selecting-values-from-results" class="table-of-contents__link toc-highlight">Selecting Values from Results</a></li><li><a href="#comparing-transformation-approaches" class="table-of-contents__link toc-highlight">Comparing Transformation Approaches</a></li></ul></li><li><a href="#advanced-cache-updates" class="table-of-contents__link toc-highlight">Advanced Cache Updates</a><ul><li><a href="#persisting-reactions" class="table-of-contents__link toc-highlight">Persisting Reactions</a></li><li><a href="#optimistic-updates-for-reactions" class="table-of-contents__link toc-highlight">Optimistic Updates for Reactions</a><ul><li><a href="#cache-update-utilities" class="table-of-contents__link toc-highlight">Cache Update Utilities</a></li><li><a href="#the-onquerystarted-lifecycle" class="table-of-contents__link toc-highlight">The <code>onQueryStarted</code> Lifecycle</a></li><li><a href="#implementing-optimistic-updates" class="table-of-contents__link toc-highlight">Implementing Optimistic Updates</a></li></ul></li><li><a href="#streaming-updates-for-notifications" class="table-of-contents__link toc-highlight">Streaming Updates for Notifications</a><ul><li><a href="#the-oncacheentryadded-lifecycle" class="table-of-contents__link toc-highlight">The <code>onCacheEntryAdded</code> Lifecycle</a></li><li><a href="#fetching-notifications" class="table-of-contents__link toc-highlight">Fetching Notifications</a></li><li><a href="#tracking-client-side-state" class="table-of-contents__link toc-highlight">Tracking Client-Side State</a></li><li><a href="#pushing-notifications-via-websocket" class="table-of-contents__link toc-highlight">Pushing Notifications Via Websocket</a></li><li><a href="#implementing-streaming-updates" class="table-of-contents__link toc-highlight">Implementing Streaming Updates</a></li></ul></li><li><a href="#cleanup" class="table-of-contents__link toc-highlight">Cleanup</a></li></ul></li><li><a href="#what-youve-learned" class="table-of-contents__link toc-highlight">What You&#39;ve Learned</a></li><li><a href="#whats-next" class="table-of-contents__link toc-highlight">What&#39;s Next?</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/introduction/getting-started">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" type="doc" href="/usage">Usage Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/tutorials/essentials/part-1-overview-concepts">Tutorial</a></li><li class="footer__item"><a class="footer__link-item" href="/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" type="doc" href="/api/api-reference">API Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/0ZcbPKXt5bZ6au5t" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reactiflux Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="http://stackoverflow.com/questions/tagged/redux" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/introduction/getting-started#help-and-discussion">Feedback</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/reduxjs/redux" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item">
                <a href="https://www.netlify.com">
                  <img src="https://www.netlify.com/img/global/badges/netlify-color-accent.svg" alt="Deployed by Netlify">
                </a>
              </li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://redux.js.org/" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/redux.svg" alt="Redux Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/redux.svg" alt="Redux Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class="footer__copyright">Copyright © 2015–2025 Dan Abramov and the Redux documentation authors.</div></div></div></footer></div>
</body>
</html>