# Site configuration for ssdd.kevinalthaus.com
# HTTPS reverse proxy with path-based routing to backend services

# HTTP to HTTPS redirect
server {
    listen 80;
    server_name ssdd.kevinalthaus.com;

    # Redirect all HTTP traffic to HTTPS
    return 301 https://$server_name$request_uri;
}

# Main HTTPS server block
server {
    listen 443 ssl http2;
    server_name ssdd.kevinalthaus.com;

    # SSL Certificate Configuration
    ssl_certificate ssl/ssdd.kevinalthaus.com.crt;
    ssl_certificate_key ssl/ssdd.kevinalthaus.com.key;

    # SSL Protocol Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # SSL Session Settings
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # =====================================================
    # Dashboard (Flask) - Root and API
    # =====================================================

    # Root location - Flask Dashboard
    location / {
        proxy_pass http://127.0.0.1:80/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }

    # Dashboard API
    location /api/ {
        proxy_pass http://127.0.0.1:80/api/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }

    # Socket.IO WebSocket
    location /socket.io/ {
        proxy_pass http://127.0.0.1:80/socket.io/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # =====================================================
    # N8N Workflow Automation (Port 5678)
    # =====================================================
    location /n8n/ {
        proxy_pass http://127.0.0.1:5678/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # =====================================================
    # ComfyUI Image Generation (Port 8188)
    # =====================================================
    location /comfyui/ {
        proxy_pass http://127.0.0.1:8188/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Disable buffering for streaming responses
        proxy_buffering off;
        proxy_request_buffering off;

        # Extended timeout for image generation
        proxy_read_timeout 600s;
    }

    # =====================================================
    # Open WebUI LLM Chat (Port 3000)
    # =====================================================
    location /openwebui/ {
        proxy_pass http://127.0.0.1:3000/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Extended timeout for LLM chat responses
        proxy_read_timeout 600s;
    }

    # =====================================================
    # AllTalk TTS (Port 7851)
    # =====================================================
    location /alltalk/ {
        proxy_pass http://127.0.0.1:7851/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }

    # =====================================================
    # Wan2GP Video Generation (Port 7860) - Gradio
    # =====================================================
    location /wan2gp/ {
        proxy_pass http://127.0.0.1:7860/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support for Gradio
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Gradio-specific settings
        proxy_buffering off;
        proxy_request_buffering off;

        # Extended timeout for video generation
        proxy_read_timeout 900s;
    }

    # =====================================================
    # YuE Music Generation (Port 7870) - Gradio
    # =====================================================
    location /yue/ {
        proxy_pass http://127.0.0.1:7870/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support for Gradio
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Gradio-specific settings
        proxy_buffering off;
        proxy_request_buffering off;

        # Extended timeout for music generation
        proxy_read_timeout 600s;
    }

    # =====================================================
    # DiffRhythm Music Generation (Port 7871) - Gradio
    # =====================================================
    location /diffrhythm/ {
        proxy_pass http://127.0.0.1:7871/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support for Gradio
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Gradio-specific settings
        proxy_buffering off;
        proxy_request_buffering off;

        # Extended timeout for music generation
        proxy_read_timeout 600s;
    }

    # =====================================================
    # MusicGen Audio Generation (Port 7872) - Gradio
    # =====================================================
    location /musicgen/ {
        proxy_pass http://127.0.0.1:7872/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support for Gradio
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Gradio-specific settings
        proxy_buffering off;
        proxy_request_buffering off;

        # Extended timeout for audio generation
        proxy_read_timeout 600s;
    }

    # =====================================================
    # Stable Audio Generation (Port 7873) - Gradio
    # =====================================================
    location /stable-audio/ {
        proxy_pass http://127.0.0.1:7873/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support for Gradio
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Gradio-specific settings
        proxy_buffering off;
        proxy_request_buffering off;

        # Extended timeout for audio generation
        proxy_read_timeout 600s;
    }

    # =====================================================
    # Ollama LLM API (Port 11434)
    # =====================================================
    location /ollama/ {
        proxy_pass http://127.0.0.1:11434/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Streaming support for LLM responses
        proxy_buffering off;
        proxy_request_buffering off;

        # Timeout for LLM generations (reduced from 900s to prevent DoS)
        # 120s should be sufficient for most LLM operations
        proxy_read_timeout 120s;

        # Rate limiting to prevent abuse
        # Allow bursts but enforce per-IP rate limit
        limit_req zone=ollama_limit burst=20 nodelay;
    }

    # =====================================================
    # Weaviate Vector Database HTTP (Port 8080)
    # =====================================================
    location /weaviate/ {
        proxy_pass http://127.0.0.1:8080/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }

    # =====================================================
    # Weaviate Console (Port 8081)
    # =====================================================
    location /weaviate-console/ {
        proxy_pass http://127.0.0.1:8081/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # =====================================================
    # A1111 Stable Diffusion WebUI (Port 7861) - Gradio
    # =====================================================
    location /a1111/ {
        proxy_pass http://127.0.0.1:7861/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support for Gradio
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Gradio-specific settings
        proxy_buffering off;
        proxy_request_buffering off;

        # Extended timeout for image generation
        proxy_read_timeout 600s;
    }

    # =====================================================
    # SD Forge (Port 7862) - Gradio
    # =====================================================
    location /forge/ {
        proxy_pass http://127.0.0.1:7862/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support for Gradio
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Gradio-specific settings
        proxy_buffering off;
        proxy_request_buffering off;

        # Extended timeout for image generation
        proxy_read_timeout 600s;
    }

    # =====================================================
    # Fooocus (Port 7865) - Gradio
    # =====================================================
    location /fooocus/ {
        proxy_pass http://127.0.0.1:7865/;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support for Gradio
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Gradio-specific settings
        proxy_buffering off;
        proxy_request_buffering off;

        # Extended timeout for image generation
        proxy_read_timeout 600s;
    }
}
