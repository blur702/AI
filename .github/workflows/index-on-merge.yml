# Index Changed Files to Weaviate on Merge
#
# NOTE: This workflow is DISABLED for automatic runs because:
# 1. Weaviate runs locally and requires a self-hosted runner
# 2. The local git hook (scripts/git-hooks/post-merge) handles automatic indexing
#
# Use workflow_dispatch for manual re-indexing if needed.
# To enable automatic indexing, set up a self-hosted runner:
# https://docs.github.com/en/actions/hosting-your-own-runners

name: Index to Vector DB

on:
  # DISABLED: push triggers - use local post-merge hook instead
  # push:
  #   branches: [master, main]
  #   paths:
  #     - '**.py'
  #     - '**.ts'
  #     - '**.tsx'
  #     - '**.js'
  #     - '**.jsx'
  #     - '**.css'
  #     - '**.md'

  # Manual trigger only - requires self-hosted runner
  workflow_dispatch:
    inputs:
      files:
        description: 'Space-separated list of files to index (leave empty for git diff)'
        required: false
        type: string

jobs:
  index:
    runs-on: self-hosted  # MUST be self-hosted to access local Weaviate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit for diff

      - name: Get changed files
        id: changed
        run: |
          if [ -n "${{ inputs.files }}" ]; then
            echo "files=${{ inputs.files }}" >> $GITHUB_OUTPUT
          else
            # Get files changed in this push
            CHANGED=$(git diff --name-only HEAD~1 HEAD | tr '\n' ' ')
            echo "files=$CHANGED" >> $GITHUB_OUTPUT
          fi

      - name: Index to Weaviate
        if: steps.changed.outputs.files != ''
        run: |
          echo "Indexing files: ${{ steps.changed.outputs.files }}"
          python -m api_gateway.services.incremental_indexer \
            --files ${{ steps.changed.outputs.files }}
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Summary
        run: |
          echo "## Indexing Complete" >> $GITHUB_STEP_SUMMARY
          echo "Files processed: ${{ steps.changed.outputs.files }}" >> $GITHUB_STEP_SUMMARY
