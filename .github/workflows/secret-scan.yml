name: Secret Scan

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]

jobs:
  scan-secrets:
    name: Scan for secrets in .env files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Scan .env files for secrets
        run: |
          python scripts/check-env-secrets.py --ci

      - name: Check for .env files (non-example)
        run: |
          # Find any .env files that aren't .env.example
          ENV_FILES=$(find . -name ".env" -o -name ".env.local" -o -name ".env.*.local" 2>/dev/null | grep -v node_modules | grep -v ".env.example" || true)

          if [ -n "$ENV_FILES" ]; then
            echo "::error::Found .env files that should not be committed:"
            echo "$ENV_FILES"
            echo ""
            echo "Only .env.example template files should be in version control."
            exit 1
          fi

          echo "âœ“ No unauthorized .env files found"

      - name: Scan with gitleaks (optional deep scan)
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true  # Advisory only - main check is above
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
