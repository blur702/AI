# CodeRabbit Auto-Fix Pipeline v2 (Safe Implementation)
#
# Key safety features:
# - Language validation: Ensures code blocks match target file types
# - Syntax validation: Rejects fixes that would break file syntax
# - Confidence threshold: Only applies high-confidence fixes
# - No fuzzy matching: Prevents wrong-code replacement

name: CodeRabbit Auto-Fix Loop

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      max_iterations:
        description: 'Maximum fix iterations'
        required: false
        default: '3'
      min_confidence:
        description: 'Minimum confidence threshold (0.0-1.0)'
        required: false
        default: '0.7'
      pr_number:
        description: 'PR number to process (for manual trigger)'
        required: false

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  MAX_ITERATIONS: ${{ github.event.inputs.max_iterations || '3' }}
  MIN_CONFIDENCE: ${{ github.event.inputs.min_confidence || '0.7' }}
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  autofix-loop:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          pip install requests pyyaml
          npm ci --ignore-scripts || npm install --ignore-scripts

      - name: Install linting tools
        run: |
          pip install ruff black isort
          npm install -g eslint prettier typescript

      - name: Get PR number
        id: pr
        run: |
          if [ -n "${{ github.event.inputs.pr_number }}" ]; then
            echo "number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.pull_request.number }}" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "::error::PR number not available"
            exit 1
          fi

      - name: Run Auto-Fix Loop
        id: autofix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          REPO: ${{ github.repository }}
        run: |
          python .github/scripts/coderabbit_autofix.py \
            --repo "$REPO" \
            --pr "$PR_NUMBER" \
            --max-iterations "$MAX_ITERATIONS" \
            --min-confidence "$MIN_CONFIDENCE" \
            --output-summary autofix_summary.md

      - name: Upload fix summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: autofix-summary
          path: autofix_summary.md
          if-no-files-found: ignore

      - name: Validate Python syntax before commit
        run: |
          echo "Validating Python syntax..."
          find . -name "*.py" -not -path "./node_modules/*" -not -path "./.venv/*" | while read -r file; do
            if ! python -m py_compile "$file" 2>/dev/null; then
              echo "::error file=$file::Syntax error in $file"
              python -m py_compile "$file"
            fi
          done
          echo "Python syntax validation passed"

      - name: Commit fixes
        if: steps.autofix.outputs.fixes_applied == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Exclude workflow files - GitHub Apps can't push workflow changes
          git add -u -- ':!.github/workflows/*'

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "fix: Auto-apply CodeRabbit suggestions

          Applied automated fixes from CodeRabbit review.

          $(head -c 500 autofix_summary.md 2>/dev/null || echo 'See workflow run for details.')

          ðŸ¤– Generated with CodeRabbit Auto-Fix v2"
            git push
          fi

      - name: Post summary comment
        if: always() && steps.pr.outputs.number
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = 'No fixes were applied.';
            try {
              summary = fs.readFileSync('autofix_summary.md', 'utf8');
            } catch (e) {
              console.log('No summary file found');
            }

            const body = `## ðŸ¤– CodeRabbit Auto-Fix Summary (v2)

            ${summary}

            ---
            *This is an automated comment from the CodeRabbit Auto-Fix workflow.*
            *v2 includes language validation and syntax checking to prevent incorrect fixes.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: body
            });

  # Separate job to run linters and catch issues CodeRabbit might flag
  lint-check:
    runs-on: ubuntu-latest
    needs: autofix-loop
    if: always() && github.event.pull_request.state == 'open'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install linters
        run: |
          pip install ruff black isort
          npm ci --ignore-scripts || npm install --ignore-scripts

      - name: Run Python linters
        continue-on-error: true
        run: |
          echo "### Ruff Check" >> $GITHUB_STEP_SUMMARY
          ruff check . --output-format=github || true
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Black Check" >> $GITHUB_STEP_SUMMARY
          black --check --diff . 2>&1 | head -100 || true
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Run TypeScript/JavaScript linters
        continue-on-error: true
        run: |
          echo "### ESLint Check" >> $GITHUB_STEP_SUMMARY
          npx eslint . --ext .ts,.tsx,.js,.jsx --format stylish 2>&1 | head -100 || true
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          echo "## Lint Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "Review the output above for any remaining issues." >> $GITHUB_STEP_SUMMARY
