<?php

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Session\AccountInterface;
use Drupal\node\NodeInterface;
/**
 * Implements hook_node_access().
 */
function page_password_protect_node_access(NodeInterface $node, $operation, AccountInterface $account) {
  if ($operation !== 'view') {
    return AccessResult::neutral();
  }

  $service = \Drupal::service('page_password_protect.password_protection');
  if (!$service->isProtected($node)) {
    return AccessResult::neutral();
  }

  if ($service->checkAccess($node, $account)) {
    return AccessResult::allowed()->addCacheableDependency($node);
  }

  return AccessResult::forbidden('Password required to view this content.')
    ->addCacheableDependency($node)
    ->addCacheContexts(['session', 'user']);
}

/**
 * Implements hook_node_view().
 */
function page_password_protect_node_view(array &$build, NodeInterface $node, $view_mode, $langcode) {
  // All password protection rendering and redirects happen during access checking.
}

/**
 * Implements hook_theme().
 */
function page_password_protect_theme($existing, $type, $theme, $path) {
  return [
    'page_password_protect_form' => [
      'variables' => [
        'node' => NULL,
        'hint' => '',
        'custom_message' => '',
        'access_url' => NULL,
      ],
      'template' => 'page-password-protect-form',
    ],
    'page_password_protect_denied' => [
      'variables' => [
        'node' => NULL,
        'custom_message' => '',
      ],
      'template' => 'page-password-protect-denied',
    ],
  ];
}

/**
 * Implements hook_help().
 */
function page_password_protect_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.page_password_protect':
      return t('The Page Password Protect module lets administrators secure nodes with custom passwords. Use the Password Protection tab on a node edit form to configure the password, hint, and custom message. Visitors without the \'bypass page password\' permission will be redirected to the password form route to gain access.');
    case 'page_password_protect.admin_form':
      return t('Use the Password Protection tab on a node to set or remove the password that visitors must enter to access that content. Administrators with the \'bypass page password\' permission can always view protected nodes.');
  }
  return '';
}

/**
 * Implements hook_form_alter().
 */
function page_password_protect_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  if (strpos($form_id, 'node_') !== 0 || empty($form['#node']) || !($form['#node'] instanceof NodeInterface)) {
    return;
  }

  $current_user = \Drupal::currentUser();
  if (!$current_user->hasPermission('administer page passwords')) {
    return;
  }

  $node = $form['#node'];
  $form['page_password_protect'] = [
    '#type' => 'details',
    '#title' => t('Password protection'),
    '#open' => TRUE,
    '#weight' => 100,
  ];

  $form['page_password_protect']['password_protection'] = [
    '#type' => 'checkbox',
    '#title' => t('Enable password protection for this node'),
    '#default_value' => ($node->hasField('field_page_password_protected') && !$node->get('field_page_password_protected')->isEmpty()) ? $node->get('field_page_password_protected')->value : 0,
  ];

  $form['page_password_protect']['password_hint'] = [
    '#type' => 'textfield',
    '#title' => t('Password hint'),
    '#default_value' => ($node->hasField('field_page_password_hint') && !$node->get('field_page_password_hint')->isEmpty()) ? $node->get('field_page_password_hint')->value : '',
    '#maxlength' => 255,
  ];

  $form['page_password_protect']['custom_message'] = [
    '#type' => 'textarea',
    '#title' => t('Custom message'),
    '#description' => t('Displayed above the password form when access is denied.'),
    '#default_value' => ($node->hasField('field_page_password_custom_message') && !$node->get('field_page_password_custom_message')->isEmpty()) ? $node->get('field_page_password_custom_message')->value : '',
  ];
}

/**
 * Determines if a node is marked as protected.
 */
function page_password_protect_node_is_protected(NodeInterface $node) {
  return \Drupal::service('page_password_protect.password_protection')->isProtected($node);
}

/**
 * Checks if the current session is authorized for the given node.
 */
function page_password_protect_is_node_authorized(NodeInterface $node) {
  return \Drupal::service('page_password_protect.password_protection')->checkAccess($node);
}
